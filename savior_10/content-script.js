(function(){function e(e){return e?e.replace(/(^\s+|\s+$)/gi,""):e}function t(){T.resetMedia().reportMediaCount(),I=setTimeout(t,E)}var i={EXTENSION_RE:/\.([^/.]*)$/i,FILENAME_RE:/([^/]+)$/i,SIZES:["","K","M","G","T","P"],xmlParser:new DOMParser,urlParser:document.createElement("a"),fileDownloader:document.createElement("a"),strip:function(e){return e.replace(/(^\s+)|(\s+$)/m,"")},query:function(e){return document.querySelector(e)},queryAll:function(e){return i.toArray(document.querySelectorAll(e))},toArray:function(e){return Array.prototype.slice.call(e)},unique:function(e){var t=[];return Array.isArray(e)?(e.forEach(function(e){-1===t.indexOf(e)&&t.push(e)}),t):e},extend:function(e,t){var i=function(){};i.prototype=e.prototype,t.prototype=new i,t.prototype.constructor=t,t._super=e.prototype},parseUrl:function(e){var t=i.urlParser;t.setAttribute("href",e);var r=(t.pathname.match(i.FILENAME_RE)||[])[1]||"",n=(r.match(i.EXTENSION_RE)||[])[1]||"";return r=r.replace(i.EXTENSION_RE,""),{url:e,protocol:t.protocol,host:t.host,port:t.port,pathname:t.pathname,filename:r,ext:n,search:t.search}},isMatches:function(e,t){t=Array.isArray(t)?t:[t];for(var i,r=0,n=t.length;n>r;++r)if(i=t[r],"string"==typeof i&&-1!==e.indexOf(i)||i instanceof RegExp&&e.match(i))return!0;return!1},_sendBackgroundRequest:function(e,t,r){var n=new i.Promise;return chrome.extension.sendRequest({requestType:"make_http_request",method:e,url:t,params:r},function(e){n[e.success?"resolve":"reject"](e.data)}),n},send:function(e,t,r){var n=new i.Promise,o=null;if(i.IS_CONTENT_SCRIPT)return i._sendBackgroundRequest(e,t,r);try{var a=new XMLHttpRequest;a.open(e,t,!0),a.setRequestHeader("Cache-Control","no-cache"),"object"==typeof r&&(o=Object.keys(r).map(function(e){return e+"="+r[e]}).join("&")),"POST"===e&&a.setRequestHeader("Content-type","application/x-www-form-urlencoded"),a.onload=function(){n.resolve(this.responseText)},a.onerror=function(){n.reject()},a.send(o)}catch(s){n.reject()}return n},get:function(e){return i.send("GET",e)},post:function(e,t){return i.send("POST",e,t)},_getSize:function(e){var t=new XMLHttpRequest,r=new i.Promise;return t.open("GET",e),t.setRequestHeader("Cache-Control","no-cache"),t.url=e,t.onreadystatechange=function(){var e=null;if(this.readyState>1){try{e=this.getResponseHeader("Content-Length")}catch(t){}(null!==e||200===this.status)&&(r[null===e?"reject":"resolve"](e),this.abort())}},t.send(null),r},getSize:function(e){var t=new i.Promise,r=i.IS_CONTENT_SCRIPT?r:chrome.extension.getBackgroundPage().cache;return i.Promise(r.get(e)).success(function(n){n?(t.resolve(n),r.put(e,n)):t.bind(i._getSize(e)).success(r.put.bind(r,e))}).fail(function(){t.bind(i._getSize(e)).success(r.put.bind(r,e))}),t},downloadFile:function(e,t){var r=i.fileDownloader;r.setAttribute("href",e),r.setAttribute("download",t);var n=document.createEvent("MouseEvent");n.initMouseEvent("click",!0,!0,window,1,0,0,0,0,!1,!1,!1,!1,0,null),r.dispatchEvent(n)},beautifyFileSize:function(e){if(null===e||e===void 0)return"???";for(var t=0;i.SIZES.length>t&&e>=1024;++t,e/=1024);return Math.round(10*e)/10+i.SIZES[t]+"b"},isTrue:function(e){return!!e},noop:function(){},defined:function(e){return e!==void 0},notNull:function(e){return null!==e}};try{chrome.extension.getBackgroundPage(),i.IS_CONTENT_SCRIPT=!1}catch(r){i.IS_CONTENT_SCRIPT=!0}i.Promise=function(e){if(0===arguments.length)return this._init(),this;if(e instanceof i.Promise)return e;var t=new i.Promise;return t.resolve(e),t},i.Promise.RUNNING=0,i.Promise.RESOLVED=1,i.Promise.FAILED=2,i.Promise.prototype={constructor:i.Promise,_init:function(){this._results=[],this._subscribers=[],this.state=i.Promise.RUNNING},_notify:function(){var e=this;this._subscribers.forEach(function(t){t.apply(e,e._results)}),this._subscribers=[]},resolve:function(){return this.state=i.Promise.RESOLVED,this._results=arguments,this._notify(),this},reject:function(){return this.state=i.Promise.FAILED,this._results=arguments,this._notify(),this},subscribe:function(e){this.state!==i.Promise.RUNNING?e.apply(this,this._results):this._subscribers.push(e)},done:function(e){return this.subscribe(e),this},success:function(e){var t=this;return this.subscribe(function(){t.state===i.Promise.RESOLVED&&e.apply(t,t._results)}),this},fail:function(e){var t=this;return this.subscribe(function(){t.state===i.Promise.FAILED&&e.apply(t,t._results)}),this},bind:function(e){return e=new i.Promise(e),e.success(this.resolve.bind(this)).fail(this.reject.bind(this)),this}},i.Promise.when=function(){var e=[];return e=Array.isArray(arguments[0])?arguments[0]:i.toArray(arguments),new i.Promise.When(e)},i.Promise.When=function(e){this._doneCallbacks=[],this._successCallbacks=[],this._failCallbacks=[],this._state=i.Promise.RUNNING,this._thingsToDo=e.length,this._results=Array(this._thingsToDo),this._init(e)},i.Promise.When.prototype={constructor:i.Promise.When,_init:function(e){var t=this;e.forEach(function(e,r){e=new i.Promise(e),e.subscribe(function(){e.state===i.Promise.FAILED&&(t._state=i.Promise.FAILED),t._results[r]=i.toArray(arguments),t._thingsToDo--,t._checkIsDone()})}),this._checkIsDone()},_checkIsDone:function(){if(0!==this._thingsToDo)return!1;var e=[];this._results.forEach(function(t){e=e.concat(t)}),this._state===i.Promise.FAILED?this._runCallbacks(this._failCallbacks,e):this._runCallbacks(this._successCallbacks,e),this._runCallbacks(this._doneCallbacks,e),this._doneCallbacks=[],this._successCallbacks=[],this._failCallbacks=[]},_runCallbacks:function(e,t){e.forEach(function(e){e.apply(this,t)})},done:function(e){return this._doneCallbacks.push(e),this._checkIsDone(),this},success:function(e){return this._successCallbacks.push(e),this._checkIsDone(),this},fail:function(e){return this._failCallbacks.push(e),this._checkIsDone(),this}},i.Promise.chain=function(){function e(t){if(!t.length)return r.resolve.apply(r,n);var o,a=t.shift();"function"==typeof a?(o=i.Promise(a()),o.done(function(i){n.push(i),e(t)})):(n.push(a),e(t))}var t,r=new i.Promise,n=[];return t=Array.isArray(arguments[0])?arguments[0]:i.toArray(arguments),e(t),r};var n={audio:{title:"Audio",contentTypes:[/audio/i],extensions:["mp3","flac","m4a","wma","ogg","wav","aif","mid"],ctype2extension:{midi:"mid",m4a:"m4a",mpeg:"mp3",mpeg3:"mp3",wav:"wav",aiff:"aif"}},video:{title:"Video",contentTypes:[/video/i],extensions:["mp4","mpeg4","mpg","mpeg","m4v","avi","divx","mov","wmv","movie","asf","webm","flv","3gp"],ctype2extension:{mpeg:"mp4",mp4:"mp4",m4v:"mp4","3gpp":"3gp",flv:"flv",quicktime:"mov",msvideo:"avi","ms-wmv":"wmv","ms-asf":"asf"}}},o=function(){};o.QL_HIGH="High",o.QL_MEDIUM="Medium",o.QL_LOW="Low",o.prototype={constructor:o,WEIGHTS:{format:1,quality:1},DEFAULT_QUALITY_LEVEL:o.QL_MEDIUM,QUALITY_LEVELS:[o.QL_HIGH,o.QL_MEDIUM,o.QL_LOW],DEFAULT_QUALITY_TYPE:"Standard",QUALITY_TYPES:{"Full HD":{itag:[37,46],vimeoQuality:"",zingTag:"f1080",dailymotionQuality:"hd1080URL",clipvnQuality:"5",quality:o.QL_HIGH,videoTitle:"Full HD",audioTitle:"High"},HD:{itag:[22,45],zingTag:["f720","hq"],vimeoQuality:"hd",dailymotionQuality:"hd720URL",facebookQuality:"hd_src",clipvnQuality:"4",quality:o.QL_HIGH,videoTitle:"HD",audioTitle:"High"},Standard:{itag:[44,35],zingTag:"f480",dailymotionQuality:"hqURL",vimeoQuality:"sd",facebookQuality:"sd_src",clipvnQuality:"3",quality:o.QL_MEDIUM,videoTitle:"Standard",audioTitle:"Normal"},Medium:{itag:[18,43,34],vimeoQuality:"",dailymotionQuality:"sdURL",zingTag:"source",clipvnQuality:"2",quality:o.QL_MEDIUM,videoTitle:"Medium",audioTitle:"Normal"},Small:{itag:[36,5],dailymotionQuality:"ldURL",vimeoQuality:"mobile",clipvnQuality:"1",quality:o.QL_LOW,videoTitle:"Small",audioTitle:"Low"},Mobile:{itag:[17,6],vimeoQuality:"",clipvnQuality:"0",quality:o.QL_LOW,videoTitle:"Mobile",audioTitle:"Low"}},getFacebookQuality:function(e){return this._getVideoQuality("facebookQuality",e).videoTitle},getDailymotionQuality:function(e){return this._getVideoQuality("dailymotionQuality",e).videoTitle},getZingVideoQuality:function(e){return this._getVideoQuality("zingTag",e).videoTitle},getZingAudioQuality:function(e){return this._getVideoQuality("zingTag",e).audioTitle},getYoutubeQuality:function(e){return this._getVideoQuality("itag",+e).videoTitle},getVimeoQuality:function(e){return this._getVideoQuality("vimeoQuality",e).videoTitle},getClipvnQuality:function(e){return this._getVideoQuality("clipvnQuality",e).videoTitle},_getVideoQuality:function(e,t){for(var i in this.QUALITY_TYPES){var r=this.QUALITY_TYPES[i][e];if(Array.isArray(r)||(r=[r]),-1!==r.indexOf(t))return this.QUALITY_TYPES[i]}return this.QUALITY_TYPES[this.DEFAULT_QUALITY_TYPE]},_getTypeByQualityType:function(e){for(var t in this.QUALITY_TYPES)if(e===t||e===this.QUALITY_TYPES[t].videoTitle||e===this.QUALITY_TYPES[t].audioTitle)return this.QUALITY_TYPES[t];return this.QUALITY_TYPES[this.DEFAULT_QUALITY_TYPE]},getQualityLevelByType:function(e){return Object.keys(this.QUALITY_TYPES).indexOf(this._getTypeByQualityType(e).videoTitle)},_calculateWeight:function(e,t){var i=n[t.get("type")].extensions,r=i.indexOf(t.get("ext")),o=this._getTypeByQualityType(t.get("quality")),a=this.QUALITY_LEVELS.indexOf(o.quality),s=this.WEIGHTS.format*(i.length-r-1)/i.length+this.WEIGHTS.quality*(this.QUALITY_LEVELS.length-Math.abs(e-a)-1)/this.QUALITY_LEVELS.length;return s},chooseBestDownload:function(e,t){t=t||this.DEFAULT_QUALITY_LEVEL;var i=this.QUALITY_LEVELS.indexOf(t),r=e.map(this._calculateWeight.bind(this,i)),n=0;return r.forEach(function(e,t){e>r[n]&&(n=t)}),e[n]}},window.quality=new o;var a=function(){};a.prototype.getMediaCount=function(){var e=i.queryAll("[href], [src]");return e.reduce(function(e,t){var r=i.parseUrl(t.getAttribute("href")||t.getAttribute("src")||"");for(var o in n)if(-1!==n[o].extensions.indexOf(r.ext.toLowerCase()))return e+1;return e},0)},a.prototype.getMedia=function(){for(var e=i.queryAll("[href], [src]"),t=[],r=0,o=e.length;o>r;++r){var a=e[r].href||e[r].src||"",s=i.parseUrl(a);for(var u in n)-1!==n[u].extensions.indexOf(s.ext)&&(s.type=u,t.push(s))}return t};var s=function(){this._ids=[],this._init()};s.PROTOCOL="https"===location.protocol.toLowerCase()?"https":"http",s.prototype={constructor:s,YOUTUBE_ID_RE:[/^https?:\/\/(?:www\.)?youtube(?:-nocookie)?(?:\.googleapis)?\.com\/(?:(?:v)|(?:embed)|(?:e))\/([^&\?]+)/i,/https?:\/\/(?:www\.)?youtube\.com\/.*(?:\?|&)v=([^&\?]+)/i],ITAG_TO_EXT:{5:"flv",6:"flv",13:"3gp",17:"3gp",18:"mp4",22:"mp4",34:"flv",35:"flv",36:"3gp",37:"mp4",43:"webm",44:"webm",45:"webm",46:"webm"},YOUTUBE_INFO_URL:s.PROTOCOL+"://www.youtube.com/get_video_info?video_id=",YOUTUBE_EL_PARAMS:["&el=embedded","&el=detailpage","&el=vevo",""],AGGRESSIVE_SCAN_URLS:[/^https?:\/\/(?:www\.)?facebook.com\//i],_init:function(){this._isAggressiveScan=i.isMatches(document.location.href,this.AGGRESSIVE_SCAN_URLS)},_parseFlashvars:function(e){function t(e){var i=e.split("&"),r={},n=0;return i.forEach(function(e){var i=e.split("=");if(i[0]&&i[1]!==void 0){var o=r[i[0]]===void 0?i[0]:i[0]+n++;if("url"==i[0])r[o]=decodeURIComponent(i[1]);else if("url_encoded_fmt_stream_map"===i[0]){var a=decodeURIComponent(i[1]).split(",");r[o]=a.map(function(e){return t(e)})}else r[o]="title"==i[0]?decodeURIComponent(i[1]):t(decodeURIComponent(i[1]||""))}else r=e}),r}return t(e)},_getVideoId:function(e){for(var t,i=0;this.YOUTUBE_ID_RE.length>i;++i)if(t=e.match(this.YOUTUBE_ID_RE[i]))return t[1];return null},_getMoviesById:function(e){function t(o){var a=o.shift();return a?(i.get(r.YOUTUBE_INFO_URL+e+a).success(function(e){var i=r._parseFlashvars(e);return"fail"===i.status?(t(o),void 0):(n.resolve(r._getMoviesFromFlashvars(i)),void 0)}).fail(t.bind(r,o)),void 0):(n.reject([]),void 0)}var r=this,n=new i.Promise;return t(this.YOUTUBE_EL_PARAMS.concat()),n},_getMoviesFromFlashvars:function(e){var t=[],i=this;return e.url_encoded_fmt_stream_map&&e.url_encoded_fmt_stream_map.length&&e.url_encoded_fmt_stream_map.forEach(function(r){if(r.itag&&r.url&&i.ITAG_TO_EXT[r.itag]){var n=e.title.replace(/\+(?!\+)/g," ");t.push({type:"video",url:r.url+"&signature="+r.sig,quality:quality.getYoutubeQuality(r.itag),filename:n,ext:i.ITAG_TO_EXT[r.itag]})}}),t},_getYoutubeIds:function(){var e=this,t=[],r='iframe[src*="youtube"], embed[src*="youtube"]'+(this._isAggressiveScan?', a[href*="youtube.com"]':""),n=i.queryAll(r),o=this._getVideoId(location.href),a=i.query(".channels-video-player");return o&&i.query("#movie_player, #movie_player-html5, #movie_player-flash")&&t.push(o),a&&a.dataset&&a.dataset.videoId&&t.push(a.dataset.videoId),n.forEach(function(i){var r=e._getVideoId(i.src||decodeURIComponent(i.href));r&&t.push(r)}),i.unique(t.concat(this._ids))},getMediaCount:function(){return this._getYoutubeIds().length},getMedia:function(){var e=new i.Promise,t=[];return t=this._getYoutubeIds().map(cache.proxy.bind(cache,this,"youtube_",this._getMoviesById)),i.Promise.when(t).done(function(){e.resolve(Array.prototype.concat.apply([],arguments))}),e},processRequest:function(e){switch(e.requestType){case"youtube_add_id":return this._ids.push(e.id),!0}return null}};var u=function(){};u.PROTOCOL="https"===location.protocol.toLowerCase()?"https":"http",u.prototype={constructor:u,VIDEO_ID_FROM_URL_RE:[/^(?:https?:\/\/)(?:player\.)?vimeo\.com(?:\/video)?\/([0-9]+)/i,/^(?:https?:\/\/)vimeo.com\/couchmode\/.*\/([0-9]+)/i],VIDEO_ID_FROM_VARS_RE:/(?:&|\?)clip_id=([0-9]+)(?:&|$)/i,VIDEO_INFO_URL:u.PROTOCOL+"://player.vimeo.com/config/{{id}}?type=moogaloop&referrer={{location}}",VIDEO_DOWNLOAD_URL:u.PROTOCOL+"://player.vimeo.com/play_redirect?clip_id={{id}}&sig={{signature}}&time={{timestamp}}&quality={{quality}}&codecs=H264&type=moogaloop&embed_location={{location}}",VIMEO_DATA_TTL:3e5,_getVideoIdFromUrl:function(e){for(var t,i=0;this.VIDEO_ID_FROM_URL_RE.length>i;++i)if(t=e.match(this.VIDEO_ID_FROM_URL_RE[i]),t&&t[1])return t[1];return null},_getVideoIdFromFlashvars:function(e){var t=e.match(this.VIDEO_ID_FROM_VARS_RE)||[];return t[1]},_getVideoInfo:function(e){return i.get(this.VIDEO_INFO_URL.replace("{{id}}",e).replace("{{location}}",location.href))},_createMediaFromVideoData:function(e){var t=[],i=this;return e.video.files.h264?(e.video.files.h264.forEach(function(r){t.push({type:"video",title:e.video.title,filename:e.video.title,ext:"mp4",url:i.VIDEO_DOWNLOAD_URL.replace("{{id}}",e.video.id).replace("{{signature}}",e.request.signature).replace("{{timestamp}}",e.request.timestamp).replace("{{quality}}",r).replace("{{location}}",location.href),quality:window.quality.getVimeoQuality(r)})}),t):[]},_getVideoIdFromNode:function(e){switch(e.tagName){case"IFRAME":return this._getVideoIdFromUrl(e.src);case"PARAM":return this._getVideoIdFromFlashvars(e.value);case"VIDEO":return this._getVideoIdFromFlashvars(e.src)}return null},_getVimeoIds:function(){var e=this,t=[],r=i.queryAll('iframe[src*="vimeo.com"], param[value*="vimeo.com"], video[src*="vimeo.com"]');return"vimeo.com"===location.host&&this._getVideoIdFromUrl(location.href)&&(t=[this._getVideoIdFromUrl(location.href)]),r.forEach(function(i){t.push(e._getVideoIdFromNode(i))}),i.unique(t)},_getVideoById:function(e){if(!e)return[];var t=this,r=new i.Promise;return this._getVideoInfo(e).success(function(e){try{e=JSON.parse(e);var i=t._createMediaFromVideoData(e);r.resolve(i)}catch(n){r.reject([])}}).fail(function(){r.reject([])}),r},getMediaCount:function(){return this._getVimeoIds().length},getMedia:function(){var e=new i.Promise,t=this._getVimeoIds().map(cache.proxy.bind(cache,this,"vimeo_",this._getVideoById));return i.Promise.when(t).done(function(){e.resolve(Array.prototype.concat.apply([],arguments))}),e}};var c=function(){this._init()};c.prototype={constructor:c,EMBED_VIDEO_SELECTOR:'embed[src*="facebook.com/v/"]',FB_VIDEO_SELECTOR:'embed[flashvars*="fbcdn.net"], embed[flashvars*="fbcdn-video-a"]',FB_ANCHOR_SELECTOR:"a.videoThumb",FACEBOOK_HOST_RE:/(\.|^)(facebook|fb).com$/i,URL_NAMES:["hd_src","sd_src"],EXTERNAL_VIDEO_URL:"://www.facebook.com/video/external_video.php?v=",ID_FROM_URL_RE:/^https?:\/\/(?:www\.)(?:facebook|fb)\.com\/(?:v\/|photo\.php\?v=)([0-9]+)/i,_init:function(){var e="https"===location.protocol.toLowerCase()?"https":"http";this.externalVideoUrl=e+this.EXTERNAL_VIDEO_URL,this._id=this._getUserId()},_getUserId:function(){var e,t=i.query('img[id*="profile_pic_header_"]');return t&&(e=(t.id.match(/profile_pic_header_([0-9]+)/)||[])[1]),e||null},_parseFlashvars:function(e){var t={};return e.split("&").forEach(function(e){var i=e.split("=");if("video"===i[0]||"params"===i[0])try{t[i[0]]=JSON.parse(decodeURIComponent(i[1]))}catch(r){}else t[i[0]]=decodeURIComponent(i[1])}),t},_getMoviesFromFlashvars:function(e){var t=this,r=this._parseFlashvars(e),n=[];if(r.video=r.video||r.params,r.video&&r.video.content)n=n.concat(this._createMovieData(r.video.content.video_src,r.video.content.video_title,"sd_src"));else if(r.video){var o=i.query("h2.uiHeaderTitle")||i.query(".fbPhotoMediaTitleNoFullScreen"),a=o&&i.strip(o.textContent),s=r.video.video_data||[r.video];this.URL_NAMES.forEach(function(e){s.forEach(function(i){i[e]&&(n=n.concat(t._createMovieData(i[e],a||i.video_id,e)))})})}return n},_getMoviesByUrl:function(e){var t=e.match(this.ID_FROM_URL_RE);if(!t||!t[1])return[];var r=this,n=new i.Promise;return e=this.externalVideoUrl+t[1],i.get(e).success(function(e){n.resolve(r._getMoviesFromFlashvars(e))}).fail(function(){n.reject([])}),n},_createMovieData:function(e,t,r){if(e){e=e;var n=i.parseUrl(e);return n.type="video",r&&(n.quality=quality.getFacebookQuality(r)),t&&(n.title=t.replace(/\+(?!\+)/g," ")),[n]}return[]},getMediaCount:function(){var e=this.EMBED_VIDEO_SELECTOR;return location.host.match(this.FACEBOOK_HOST_RE)&&(e+=","+this.FB_ANCHOR_SELECTOR+","+this.FB_VIDEO_SELECTOR),i.queryAll(e).length},getMedia:function(){var e=this,t=new i.Promise,r=[],n=[],o=this.EMBED_VIDEO_SELECTOR;return location.host.match(this.FACEBOOK_HOST_RE)&&(o+=","+this.FB_ANCHOR_SELECTOR),r=i.queryAll(o).map(function(e){return e.href||e.src}).map(cache.proxy.bind(cache,this,"facebook_",this._getMoviesByUrl)),n=i.queryAll(this.FB_VIDEO_SELECTOR),n.forEach(function(t){r=r.concat(e._getMoviesFromFlashvars(t.getAttribute("flashvars")))}),i.Promise.when(r).done(function(){t.resolve(Array.prototype.concat.apply([],arguments))}),t}};var l=function(){};l.prototype={constructor:l,EMBED_ID_RE:/^https?:\/\/(?:www\.)dailymotion\.com\/embed\/video\/([a-z0-9]+)/i,FLASHVARS_ID_RE:/"videoId":"([a-z0-9]+)"/i,HASH_ID_RE:/^#video=([a-z0-9]+)/i,URL_NAMES:["hd1080URL","hd720URL","hqURL","sdURL","ldURL"],DM_EMBED_SELECTOR:'param[name="flashvars"][value*="dailymotion.com"], iframe[src*="http://www.dailymotion.com/embed/video/"]',_parseSequence:function(e){function t(e){var i={};return Array.isArray(e)||(e=[e]),e.forEach(function(e){var r=e.sequenceList||e.layerList||e.items,n=e.name||e.type;if(n&&(i[n]={},r&&(i[n]=t(r)),e.param))for(var o in e.param)i[o]=e.param[o]}),i}return t(e)},_getParamSafely:function(e,t){var i,r=e;for(t=t.split(".");r&&(i=t.shift());)r=r[i];return r},_getMediaBySequence:function(e){var t=[];try{var r=this._parseSequence(e.sequence[0].layerList),n=this._getParamSafely(r,"background.main.externalTargetingParams.dm_title")||this._getParamSafely(r,"background.main.targetingParams.DMTITLE")||this._getParamSafely(r,"background.reporting.extraParams.videoTitle")||"",o=this._getParamSafely(r,"background.main");n=n.replace(/\+(?!\+)/g," ")}catch(a){return[]}return this.URL_NAMES.forEach(function(e){if(o[e]){var r=i.parseUrl(o[e]);r.quality=quality.getDailymotionQuality(e),r.title=n,r.type="video",t.push(r)}}),t},_getMediaById:function(e){var t=this,r=new i.Promise;return i.get("http://www.dailymotion.com/sequence/play/"+e+"?parentURL="+encodeURIComponent(location.href)).success(function(e){try{r.resolve(t._getMediaBySequence(JSON.parse(e)))}catch(i){r.reject([])}}).fail(function(){r.reject([])}),r},_extractIdFromNode:function(e){var t,i;"PARAM"===e.tagName?(t=this.FLASHVARS_ID_RE,i=decodeURIComponent(e.value)):(t=this.EMBED_ID_RE,i=e.src);var r=i.match(t);return r&&r[1]||null},_getIds:function(){var e=[];if("www.dailymotion.com"===location.host){var t=location.hash.match(this.HASH_ID_RE);t&&e.push(t[1])}return e.concat(i.queryAll(this.DM_EMBED_SELECTOR).map(this._extractIdFromNode.bind(this))).filter(i.isTrue)},getMediaCount:function(){return this._getIds().length},getMedia:function(){var e=new i.Promise,t=this._getIds().map(cache.proxy.bind(cache,this,"daylimotion_",this._getMediaById));return i.Promise.when(t).done(function(){e.resolve(Array.prototype.concat.apply([],arguments))}),e}};var h=function(){};i.extend(s,h),h.prototype.YOUTUBE_ID_RE=/vietgiaitri\.com\/.*id\.([^\.]+)\.vgt/i,h.prototype.getMediaCount=function(){return+!!location.href.match(this.YOUTUBE_ID_RE)},h.prototype.getMedia=function(){var e=location.href.match(this.YOUTUBE_ID_RE);return e&&e[1]?this._getMoviesById(e[1]):[]};var d=function(){};d.prototype={constructor:d,ID_FROM_URL_RE:/https?:\/\/clip\.vn\/embed\/([0-9a-z_-]+)/i,ID_FROM_FLASHVARS_RE:/(?:^|&)id=([0-9a-z_-]+)/i,_getVideoId:function(e){var t;switch(e.tagName){case"IFRAME":t=e.src.match(this.ID_FROM_URL_RE);break;case"PARAM":t=e.getAttribute("value").match(this.ID_FROM_FLASHVARS_RE)}return(t||[])[1]},_getVideoIds:function(){var e=this,t=i.queryAll('param[name="flashvars"][value*="clip.vn"], iframe[src*="clip.vn"]'),r=[];return t.forEach(function(t){var i=e._getVideoId(t);i&&r.push(i)}),r},_getVideoById:function(e){var t=new i.Promise;return i.post("http://clip.vn/movies/nfo/"+e,{onsite:"clip"}).success(function(e){try{var r=i.xmlParser.parseFromString(e,"text/xml"),n=r.querySelector("ClipInfo title"),o=i.toArray(r.querySelectorAll("ClipInfo enclosure")),a=o.map(function(e){var t=e.getAttribute("url"),r=i.parseUrl(t),o=e.getAttribute("quality");return r.type="video",n&&(r.title=n.textContent),r.quality=quality.getClipvnQuality(o),r});t.resolve(a)}catch(s){t.reject([])}}).fail(t.reject.bind(t,[])),t},getMediaCount:function(){return this._getVideoIds().length},getMedia:function(){var e=this._getVideoIds(),t=new i.Promise,r=e.map(cache.proxy.bind(cache,this,"clipvn_",this._getVideoById));return i.Promise.when(r).done(function(){t.resolve(Array.prototype.concat.apply([],arguments))}),t}};var p=function(){this._urls=[]};p.prototype={constructor:p,MEDIA_QUERY:'param[value*="mp3.zing.vn/xml/"], param[value*="tv.zing.vn/tv/xml/"]',XML_URL_RE:/xmlURL=([^&]+)/i,_getMediaFromXmlUrl:function(e){var t=new i.Promise;return i.get(e).done(function(e){console.log(e);var r=i.xmlParser.parseFromString(e,"text/xml"),n=[];i.toArray(r.querySelectorAll("data > item")).forEach(function(e){var t=e.getAttribute("type"),r=e.querySelector("title").textContent;i.toArray(e.querySelectorAll("f1080, f720, f480, source, hq")).forEach(function(e){var o=e.textContent;if("require vip"!==o){var a=i.parseUrl(o);"mp3"===t?(a.type="audio",a.quality=quality.getZingAudioQuality(e.tagName)):(a.type="video",a.quality=quality.getZingVideoQuality(e.tagName)),a.type="mp3"===t?"audio":"video",a.ext=a.ext||t,a.title=r,n.push(a)}})}),t.resolve(n)}),t},_getXmlUrls:function(){var e=this,t=i.queryAll(this.MEDIA_QUERY),r=[];return t.forEach(function(t){var i=(t.getAttribute("value").match(e.XML_URL_RE)||[])[1];i&&r.push(i)}),r},getMediaCount:function(){return this._getXmlUrls().length},getMedia:function(){var e=this._getXmlUrls(),t=new i.Promise,r=i.unique(e.concat(this._urls)).map(cache.proxy.bind(cache,this,"zing_",this._getMediaFromXmlUrl));return i.Promise.when(r).done(function(){t.resolve(Array.prototype.concat.apply([],arguments))}),t},processRequest:function(e){switch(e.requestType){case"zingvn_add_xml_url":return this._urls.push(e.url),!0}return null}};var _=function(){this._urls=[]};_.prototype={constructor:_,_getMediaFromXmlUrl:function(e){var t=new i.Promise;return i.get(e).done(function(e){var r=i.xmlParser.parseFromString(e,"text/xml"),n=[];i.toArray(r.querySelectorAll("track")).forEach(function(e){var t=e.querySelector("location").textContent,r=e.querySelector("title").textContent,o=i.parseUrl(t);o.type="mp3"===o.ext?"audio":"video",o.title=r,n.push(o)}),t.resolve(n)}),t},getMediaCount:function(){return this._urls.length},getMedia:function(){var e=new i.Promise,t=i.unique(this._urls).map(cache.proxy.bind(cache,this,"nhaccuatui_",this._getMediaFromXmlUrl));return i.Promise.when(t).done(function(){e.resolve(Array.prototype.concat.apply([],arguments))}),e},processRequest:function(e){switch(e.requestType){case"nhaccuatui_add_xml_url":return this._urls.push(e.url),!0}return null}};var m=function(){};m.prototype={constructor:m,URL_BASE:"http://vui.vn",FLASH_SELECTOR:'param[name="flashvars"][value*="vui.vn"]',_parseFlashvars:function(e){var t={};return e.split("&").forEach(function(e){var i=e.split("=");t[i[0]]=decodeURIComponent(i[1])}),t},_getMediaByPlaylistUrl:function(e){var t=new i.Promise;return e=e.match(/^https?:\/\//i)?e:this.URL_BASE+e,i.get(e).success(function(e){var r=i.xmlParser.parseFromString(e,"text/xml"),n=[];i.toArray(r.querySelectorAll("item")).forEach(function(e){try{var t=e.querySelector("title").textContent,r=e.getElementsByTagNameNS("http://developer.longtailvideo.com/","file")[0].textContent,o=i.parseUrl(r);o.type="mp3"===o.ext?"audio":"video",o.title=t,n.push(o)}catch(a){}}),t.resolve(n)}).fail(function(){t.reject([])}),t},getMediaCount:function(){return i.queryAll(this.FLASH_SELECTOR).length},getMedia:function(){var e=this,t=i.queryAll(this.FLASH_SELECTOR),r=new i.Promise,n=[];return n=t.map(function(t){var i=e._parseFlashvars(t.value);return i.playlistfile}).map(cache.proxy.bind(cache,this,"vui_",this._getMediaByPlaylistUrl)),i.Promise.when(n).done(function(){r.resolve(Array.prototype.concat.apply([],arguments))}),r}};var f=function(){this._urls=[]};f.prototype={constructor:f,NHACSO_SELECTOR:['param[name="flashvars"][value*="xmlPath=http://nhacso.net"]','iframe[src*="http://nhacso.net/embed"]','param[name="movie"][value*="xmlPath=http://nhacso.net"]'].join(","),VIDEO_URL_PREFIX:"http://nhacso.net/flash/video2/xnl/1/id/",AUDIO_URL_PREFIX:"http://nhacso.net/flash/album/xnl/1/uid/X1xQVUNcZgQEBQ==,",_getMediaByPlaylistUrl:function(e){var t=new i.Promise;return i.get(e).success(function(e){var r=i.xmlParser.parseFromString(e,"text/xml"),n=[];i.toArray(r.querySelectorAll("track")).forEach(function(e){try{var t=e.querySelector("name, title").textContent,r=e.querySelector("sourceUrl, url").textContent,o=i.parseUrl(r);o.type="mp3"===o.ext?"audio":"video",o.title=t,n.push(o)}catch(a){}}),t.resolve(n)}).fail(function(){t.reject([])}),t},_getUrlFromNode:function(e){var t,i,r=/^https?:\/\/nhacso.net\/embed\/([^\/]+)\/(.+)/i;if(e.src){if(i=e.src.match(r),3!==i.length)return null;switch(i[1]){case"album":t=this.AUDIO_URL_PREFIX+i[2];break;case"video":t=this.VIDEO_URL_PREFIX+i[2];break;default:return null}}else t=e.value.replace(/^.*xmlPath=([^&]+).*$/i,"$1");return t},getMediaCount:function(){return i.queryAll(this.NHACSO_SELECTOR).length},getMedia:function(){var e=i.queryAll(this.NHACSO_SELECTOR),t=new i.Promise,r=[];return r=i.unique(e.map(this._getUrlFromNode.bind(this)).filter(i.notNull)).map(cache.proxy.bind(cache,this,"nhacso_",this._getMediaByPlaylistUrl)),i.Promise.when(r).done(function(){t.resolve(Array.prototype.concat.apply([],arguments))}),t}};var v=function(){this._providers=[],this._init()};v.prototype={constructor:v,_init:function(){chrome.extension.onMessage.addListener(this._onMessageHandler.bind(this))},_onMessageHandler:function(e,t,r){var n;switch(e.requestType){case"get_media":this._getMedia().done(function(e){r(e)});break;case"download_file":i.downloadFile(e.url,e.filename),r();break;default:n=this._processUnknownRequest(e),n&&r(n)}return!0},_processUnknownRequest:function(e){for(var t=0;this._providers.length>t;++t){var r=this._providers[t],n=(r.processRequest||i.noop).call(r,e);if(n)return n}return null},_getMedia:function(){var e=this,t=new i.Promise,r=this._providers.map(function(e){return e.getMedia()});return i.Promise.when(r).done(function(){var i=[];i=Array.prototype.concat.apply([],arguments),t.resolve(e._excludeUnsupportedMedia(i))}),t},_excludeUnsupportedMedia:function(e){var t=[];return e.forEach(function(e){e.type in n&&-1!==n[e.type].extensions.indexOf(e.ext)&&t.push(e)}),t},resetMedia:function(){return chrome.extension.sendRequest({requestType:"reset_media"},i.noop),this},resetAllMedia:function(){return chrome.extension.sendRequest({requestType:"reset_all_media"}),this},getMediaCount:function(){return this._providers.reduce(function(e,t){return e+t.getMediaCount()},0)},reportMediaCount:function(){var e=this.getMediaCount();return chrome.extension.sendRequest({requestType:"media_count",count:e}),this},registerProviders:function(e){return Array.isArray(e)||(e=[provider]),Array.prototype.push.apply(this._providers,e),this}};var y=[{locationPatterns:[/https?:\/\/(?:www\.)?phimvang\.org\/xem-phim/i],urlPatterns:[],extractor:"title"},{locationPatterns:["clip.vietnamnet.vn"],urlPatterns:[],extractor:"#pageTitleDis"},{locationPatterns:[/^https?:\/\/(?:www\.)ustream.tv\/recorded\/([0-9]+)/i],urlPatterns:[],extractor:"#ViewerContent h2"},{locationPatterns:[/^https?:\/\/tv\.vnn\.vn\/xem-phim/i],urlPatterns:[],extractor:".video-content h1"},{locationPatterns:[/^https?:\/\/phim\.soha\.vn\/\w+\/watch/i],urlPatterns:[],extractor:"#paneloverlay h1"},{locationPatterns:[/^https?:\/\/v1vn.com\/xem-phim-online/i],urlPatterns:[],extractor:"title"},{locationPatterns:[/^https?:\/\/phim\.vnnclub\.com\/bo-phim/i],urlPatterns:[],extractor:"#tools"}];extractFileName=function(t){for(var r,n,o=0;y.length>o;++o)if(n=y[o],i.isMatches(t,n.urlPatterns)||i.isMatches(location.href,n.locationPatterns)){if("string"==typeof n.extractor)try{r=i.query(n.extractor).textContent}catch(a){}else"function"==typeof n.extractor&&(r=n.extractor());if(r)return e(r)}return null},chrome.extension.onMessage.addListener(function(e,t,i){"extract_file_name"===e.requestType&&i(extractFileName(e.url||e.media.url))});var g=function(){};g.prototype={constructor:g,get:function(e){var t=new i.Promise;return chrome.extension.sendRequest({requestType:"get_from_cache",key:e},function(e){t[null===e?"reject":"resolve"](e)}),t},put:function(e,t,i){chrome.extension.sendRequest({requestType:"put_to_cache",key:e,value:t,ttl:i})},"delete":function(){chrome.extension.sendRequest({requestType:"delete_from_cache",key:key})},proxy:function(e,t,r,n){var o=this,a=new i.Promise;return this.get(t+n).success(a.resolve.bind(a)).fail(function(){var s=new i.Promise(r.call(e,n));s.success(function(e){o.put(t+n,e)}).done(function(e){a.resolve(e)})}),a}},window.cache=new g;var E=3e3,I=null,T=new v;T.registerProviders([new a,new s,new u,new c,new p,new _,new h,new d,new m,new f,new l]),T.resetAllMedia(),window.manager=T,document.addEventListener("webkitvisibilitychange",function(){document.webkitHidden?I&&(clearTimeout(I),I=null):t()},!1),document.webkitHidden||t()})();