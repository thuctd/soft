(function(){function e(e,t){-1!==t.host.indexOf("youtube.com")&&"/api_video_info"===t.pathname&&(match=t.search.match(/(?:&|\?)video_id=([^&]+)(?:&|$)/i))&&chrome.tabs.sendMessage(e.tabId,{requestType:"youtube_add_id",id:match[1]})}function t(e,t){(t.host+t.pathname).match(/[a-z0-9]+\.zing\.vn\/([a-z-]+\/)?xml\//gi)&&chrome.tabs.sendMessage(e.tabId,{requestType:"zingvn_add_xml_url",url:t.protocol+"//"+t.host+t.pathname})}function i(e,t){"www.nhaccuatui.com"===t.host&&t.search.match(/^\?key[0-9]=[0-9a-f]{32}/i)&&chrome.tabs.sendMessage(e.tabId,{requestType:"nhaccuatui_add_xml_url",url:e.url})}var n={EXTENSION_RE:/\.([^/.]*)$/i,FILENAME_RE:/([^/]+)$/i,SIZES:["","K","M","G","T","P"],xmlParser:new DOMParser,urlParser:document.createElement("a"),fileDownloader:document.createElement("a"),strip:function(e){return e.replace(/(^\s+)|(\s+$)/m,"")},query:function(e){return document.querySelector(e)},queryAll:function(e){return n.toArray(document.querySelectorAll(e))},toArray:function(e){return Array.prototype.slice.call(e)},unique:function(e){var t=[];return Array.isArray(e)?(e.forEach(function(e){-1===t.indexOf(e)&&t.push(e)}),t):e},extend:function(e,t){var i=function(){};i.prototype=e.prototype,t.prototype=new i,t.prototype.constructor=t,t._super=e.prototype},parseUrl:function(e){var t=n.urlParser;t.setAttribute("href",e);var i=(t.pathname.match(n.FILENAME_RE)||[])[1]||"",s=(i.match(n.EXTENSION_RE)||[])[1]||"";return i=i.replace(n.EXTENSION_RE,""),{url:e,protocol:t.protocol,host:t.host,port:t.port,pathname:t.pathname,filename:i,ext:s,search:t.search}},isMatches:function(e,t){t=Array.isArray(t)?t:[t];for(var i,n=0,s=t.length;s>n;++n)if(i=t[n],"string"==typeof i&&-1!==e.indexOf(i)||i instanceof RegExp&&e.match(i))return!0;return!1},_sendBackgroundRequest:function(e,t,i){var s=new n.Promise;return chrome.extension.sendRequest({requestType:"make_http_request",method:e,url:t,params:i},function(e){s[e.success?"resolve":"reject"](e.data)}),s},send:function(e,t,i){var s=new n.Promise,o=null;if(n.IS_CONTENT_SCRIPT)return n._sendBackgroundRequest(e,t,i);try{var r=new XMLHttpRequest;r.open(e,t,!0),r.setRequestHeader("Cache-Control","no-cache"),"object"==typeof i&&(o=Object.keys(i).map(function(e){return e+"="+i[e]}).join("&")),"POST"===e&&r.setRequestHeader("Content-type","application/x-www-form-urlencoded"),r.onload=function(){s.resolve(this.responseText)},r.onerror=function(){s.reject()},r.send(o)}catch(a){s.reject()}return s},get:function(e){return n.send("GET",e)},post:function(e,t){return n.send("POST",e,t)},_getSize:function(e){var t=new XMLHttpRequest,i=new n.Promise;return t.open("GET",e),t.setRequestHeader("Cache-Control","no-cache"),t.url=e,t.onreadystatechange=function(){var e=null;if(this.readyState>1){try{e=this.getResponseHeader("Content-Length")}catch(t){}(null!==e||200===this.status)&&(i[null===e?"reject":"resolve"](e),this.abort())}},t.send(null),i},getSize:function(e){var t=new n.Promise,i=n.IS_CONTENT_SCRIPT?i:chrome.extension.getBackgroundPage().cache;return n.Promise(i.get(e)).success(function(s){s?(t.resolve(s),i.put(e,s)):t.bind(n._getSize(e)).success(i.put.bind(i,e))}).fail(function(){t.bind(n._getSize(e)).success(i.put.bind(i,e))}),t},downloadFile:function(e,t){var i=n.fileDownloader;i.setAttribute("href",e),i.setAttribute("download",t);var s=document.createEvent("MouseEvent");s.initMouseEvent("click",!0,!0,window,1,0,0,0,0,!1,!1,!1,!1,0,null),i.dispatchEvent(s)},beautifyFileSize:function(e){if(null===e||e===void 0)return"???";for(var t=0;n.SIZES.length>t&&e>=1024;++t,e/=1024);return Math.round(10*e)/10+n.SIZES[t]+"b"},isTrue:function(e){return!!e},noop:function(){},defined:function(e){return e!==void 0},notNull:function(e){return null!==e}};try{chrome.extension.getBackgroundPage(),n.IS_CONTENT_SCRIPT=!1}catch(s){n.IS_CONTENT_SCRIPT=!0}n.Promise=function(e){if(0===arguments.length)return this._init(),this;if(e instanceof n.Promise)return e;var t=new n.Promise;return t.resolve(e),t},n.Promise.RUNNING=0,n.Promise.RESOLVED=1,n.Promise.FAILED=2,n.Promise.prototype={constructor:n.Promise,_init:function(){this._results=[],this._subscribers=[],this.state=n.Promise.RUNNING},_notify:function(){var e=this;this._subscribers.forEach(function(t){t.apply(e,e._results)}),this._subscribers=[]},resolve:function(){return this.state=n.Promise.RESOLVED,this._results=arguments,this._notify(),this},reject:function(){return this.state=n.Promise.FAILED,this._results=arguments,this._notify(),this},subscribe:function(e){this.state!==n.Promise.RUNNING?e.apply(this,this._results):this._subscribers.push(e)},done:function(e){return this.subscribe(e),this},success:function(e){var t=this;return this.subscribe(function(){t.state===n.Promise.RESOLVED&&e.apply(t,t._results)}),this},fail:function(e){var t=this;return this.subscribe(function(){t.state===n.Promise.FAILED&&e.apply(t,t._results)}),this},bind:function(e){return e=new n.Promise(e),e.success(this.resolve.bind(this)).fail(this.reject.bind(this)),this}},n.Promise.when=function(){var e=[];return e=Array.isArray(arguments[0])?arguments[0]:n.toArray(arguments),new n.Promise.When(e)},n.Promise.When=function(e){this._doneCallbacks=[],this._successCallbacks=[],this._failCallbacks=[],this._state=n.Promise.RUNNING,this._thingsToDo=e.length,this._results=Array(this._thingsToDo),this._init(e)},n.Promise.When.prototype={constructor:n.Promise.When,_init:function(e){var t=this;e.forEach(function(e,i){e=new n.Promise(e),e.subscribe(function(){e.state===n.Promise.FAILED&&(t._state=n.Promise.FAILED),t._results[i]=n.toArray(arguments),t._thingsToDo--,t._checkIsDone()})}),this._checkIsDone()},_checkIsDone:function(){if(0!==this._thingsToDo)return!1;var e=[];this._results.forEach(function(t){e=e.concat(t)}),this._state===n.Promise.FAILED?this._runCallbacks(this._failCallbacks,e):this._runCallbacks(this._successCallbacks,e),this._runCallbacks(this._doneCallbacks,e),this._doneCallbacks=[],this._successCallbacks=[],this._failCallbacks=[]},_runCallbacks:function(e,t){e.forEach(function(e){e.apply(this,t)})},done:function(e){return this._doneCallbacks.push(e),this._checkIsDone(),this},success:function(e){return this._successCallbacks.push(e),this._checkIsDone(),this},fail:function(e){return this._failCallbacks.push(e),this._checkIsDone(),this}},n.Promise.chain=function(){function e(t){if(!t.length)return i.resolve.apply(i,s);var o,r=t.shift();"function"==typeof r?(o=n.Promise(r()),o.done(function(i){s.push(i),e(t)})):(s.push(r),e(t))}var t,i=new n.Promise,s=[];return t=Array.isArray(arguments[0])?arguments[0]:n.toArray(arguments),e(t),i};var o={audio:{title:"Audio",contentTypes:[/audio/i],extensions:["mp3","flac","m4a","wma","ogg","wav","aif","mid"],ctype2extension:{midi:"mid",m4a:"m4a",mpeg:"mp3",mpeg3:"mp3",wav:"wav",aiff:"aif"}},video:{title:"Video",contentTypes:[/video/i],extensions:["mp4","mpeg4","mpg","mpeg","m4v","avi","divx","mov","wmv","movie","asf","webm","flv","3gp"],ctype2extension:{mpeg:"mp4",mp4:"mp4",m4v:"mp4","3gpp":"3gp",flv:"flv",quicktime:"mov",msvideo:"avi","ms-wmv":"wmv","ms-asf":"asf"}}},r=function(){this._storage=chrome.storage.local,this._options={}};r.prototype={load:function(){var e=new n.Promise,t=this;return this._storage.get(null,function(i){t._options=i,e.resolve(i)}),e},set:function(e,t){var i={};("string"==typeof e||"number"==typeof e&&t!==void 0)&&(i[e]=t,this._options[e]=t,this._storage.set(i))},get:function(e){return this._options[e]}};var a=function(){};a.QL_HIGH="High",a.QL_MEDIUM="Medium",a.QL_LOW="Low",a.prototype={constructor:a,WEIGHTS:{format:1,quality:1},DEFAULT_QUALITY_LEVEL:a.QL_MEDIUM,QUALITY_LEVELS:[a.QL_HIGH,a.QL_MEDIUM,a.QL_LOW],DEFAULT_QUALITY_TYPE:"Standard",QUALITY_TYPES:{"Full HD":{itag:[37,46],vimeoQuality:"",zingTag:"f1080",dailymotionQuality:"hd1080URL",clipvnQuality:"5",quality:a.QL_HIGH,videoTitle:"Full HD",audioTitle:"High"},HD:{itag:[22,45],zingTag:["f720","hq"],vimeoQuality:"hd",dailymotionQuality:"hd720URL",facebookQuality:"hd_src",clipvnQuality:"4",quality:a.QL_HIGH,videoTitle:"HD",audioTitle:"High"},Standard:{itag:[44,35],zingTag:"f480",dailymotionQuality:"hqURL",vimeoQuality:"sd",facebookQuality:"sd_src",clipvnQuality:"3",quality:a.QL_MEDIUM,videoTitle:"Standard",audioTitle:"Normal"},Medium:{itag:[18,43,34],vimeoQuality:"",dailymotionQuality:"sdURL",zingTag:"source",clipvnQuality:"2",quality:a.QL_MEDIUM,videoTitle:"Medium",audioTitle:"Normal"},Small:{itag:[36,5],dailymotionQuality:"ldURL",vimeoQuality:"mobile",clipvnQuality:"1",quality:a.QL_LOW,videoTitle:"Small",audioTitle:"Low"},Mobile:{itag:[17,6],vimeoQuality:"",clipvnQuality:"0",quality:a.QL_LOW,videoTitle:"Mobile",audioTitle:"Low"}},getFacebookQuality:function(e){return this._getVideoQuality("facebookQuality",e).videoTitle},getDailymotionQuality:function(e){return this._getVideoQuality("dailymotionQuality",e).videoTitle},getZingVideoQuality:function(e){return this._getVideoQuality("zingTag",e).videoTitle},getZingAudioQuality:function(e){return this._getVideoQuality("zingTag",e).audioTitle},getYoutubeQuality:function(e){return this._getVideoQuality("itag",+e).videoTitle},getVimeoQuality:function(e){return this._getVideoQuality("vimeoQuality",e).videoTitle},getClipvnQuality:function(e){return this._getVideoQuality("clipvnQuality",e).videoTitle},_getVideoQuality:function(e,t){for(var i in this.QUALITY_TYPES){var n=this.QUALITY_TYPES[i][e];if(Array.isArray(n)||(n=[n]),-1!==n.indexOf(t))return this.QUALITY_TYPES[i]}return this.QUALITY_TYPES[this.DEFAULT_QUALITY_TYPE]},_getTypeByQualityType:function(e){for(var t in this.QUALITY_TYPES)if(e===t||e===this.QUALITY_TYPES[t].videoTitle||e===this.QUALITY_TYPES[t].audioTitle)return this.QUALITY_TYPES[t];return this.QUALITY_TYPES[this.DEFAULT_QUALITY_TYPE]},getQualityLevelByType:function(e){return Object.keys(this.QUALITY_TYPES).indexOf(this._getTypeByQualityType(e).videoTitle)},_calculateWeight:function(e,t){var i=o[t.get("type")].extensions,n=i.indexOf(t.get("ext")),s=this._getTypeByQualityType(t.get("quality")),r=this.QUALITY_LEVELS.indexOf(s.quality),a=this.WEIGHTS.format*(i.length-n-1)/i.length+this.WEIGHTS.quality*(this.QUALITY_LEVELS.length-Math.abs(e-r)-1)/this.QUALITY_LEVELS.length;return a},chooseBestDownload:function(e,t){t=t||this.DEFAULT_QUALITY_LEVEL;var i=this.QUALITY_LEVELS.indexOf(t),n=e.map(this._calculateWeight.bind(this,i)),s=0;return n.forEach(function(e,t){e>n[s]&&(s=t)}),e[s]}},window.quality=new a;var u=function(){this._cache={}};u.prototype={constructor:u,DEFAULT_TTL:12e5,get:function(e){return this._cache[e]?this._cache[e]:void 0},put:function(e,t,i){e&&t!==void 0&&(i=i||this.DEFAULT_TTL,this._cache[e]=t,setTimeout(this["delete"].bind(this,e),i))},"delete":function(e){this._cache[e]&&delete this._cache[e]}};var c=function(e){this._values={},e.id=e.id||(""+Math.random()).substring(2),this.merge(e)};c.MAX_FILE_NAME_LENGTH=128,c.prototype._createFieldGetter=function(e){this[e]=function(){return this.get(e)}},c.prototype.get=function(e){return"string"==typeof e||"number"==typeof e?this._values[e]:void 0},c.prototype.set=function(e,t){return"string"!=typeof e&&"number"!=typeof e||this._values[e]===t||(this._values[e]=t,this[e]||this._createFieldGetter(e)),this},c.prototype.merge=function(e){var t=e instanceof c?e._values:e;for(var i in t)this.set(i,t[i]!==void 0?t[i]:t[i]||null);return this},c.prototype.title=function(){return(this._values.title||this._values.filename).substr(0,c.MAX_FILE_NAME_LENGTH)},c.prototype.size=function(){var e=this.get("size");return e?"("+n.beautifyFileSize(e)+")":""},c.prototype.getSize=function(){var e=this,t=new n.Promise,i=this.get("url"),s=this.get("altUrl"),o=this.get("size");return o?(t.resolve(o),t):(n.getSize(i).success(function(i){e.set("size",i),t.resolve(i)}).fail(function(){if(s){var o=n.getSize(s);o.success(function(t){e.set("size",t),cache.put("filesize_"+i,t)}),t.bind(o)}else t.reject(null)}),t)};var l=function(){this._counts={},this._streamMedia={}};l.prototype={constructor:l,_getMediaCount:function(e){return(this._counts[e]||0)+(this._streamMedia[e]||[]).length},showPageActionState:function(e){var t=this._getMediaCount(e);chrome.pageAction[t?"show":"hide"](e),t&&!options.get("not_first_run")&&chrome.pageAction.showPopup&&setTimeout(function(){chrome.tabs.query({active:!0,windowType:"normal"},function(t){t.length&&t[0].id==e&&(options.get("not_first_run")||chrome.pageAction.showPopup())})},5e3)},_requestMediaFromCS:function(e){var t=new n.Promise;return chrome.tabs.sendMessage(e,{requestType:"get_media"},function(e){t.resolve(e)}),t},_requestMediaFromBG:function(e){return this._streamMedia[e]=this._streamMedia[e]||[],this._streamMedia[e]},addStreamMedia:function(e,t){this._streamMedia[e]=this._streamMedia[e]||[],Array.isArray(t)?this._streamMedia[e]=this._streamMedia[e].concat(t):this._streamMedia[e].push(t),this.showPageActionState(e)},resetMediaCount:function(e){this._counts[e]=0},resetAllMediaCount:function(e){this._streamMedia[e]=[],this.resetMediaCount(e),this.showPageActionState(e)},addMediaCount:function(e,t){this._counts[e]=this._counts[e]||0,this._counts[e]+=t,this.showPageActionState(e)},getMediaForTab:function(e){var t=new n.Promise;return n.Promise.when(this._requestMediaFromCS(e),this._requestMediaFromBG(e)).done(function(){var e=Array.prototype.concat.apply([],arguments),i=[],n={};e.forEach(function(e){!e||n[e.url]||e.altUrl&&n[e.altUrl]||(i.push(new c(e)),n[e.url]=!0,e.altUrl&&(n[e.altUrl]=!0))}),t.resolve(i)}),t}},window.db=new l;var h=function(){};h.prototype={constructor:h,EXCLUDE_URLS:["youtube.com","vimeo.com","fbcdn.net",/(.+\.)?clip.vn$/i,"subs.xemphimonlines.com","dailymotion.com","dmcdn.net","nhacrap.tv","nixcdn.com",/(.+\.)?zdn.vn$/i,"vui.vn",/(.+\.)?24hstatic.com$/i,"adnetwork.vn","doubleclick.net"],MIN_STREAM_SIZE:30720,processRequest:function(e,t,i){var s,r;if(!n.isMatches(t.host,this.EXCLUDE_URLS)&&i["content-type"]&&(r=this._getMediaType(i["content-type"],t.ext))){if(!r||!o[r])return;if(-1===o[r].extensions.indexOf(t.ext)&&(t.ext=this._extByContentType(i["content-type"],r)),s={type:r,url:e.url,filename:t.filename,ext:t.ext},302!==e.statusCode&&i["content-length"]&&(s.size=i["content-length"],this.MIN_STREAM_SIZE>s.size))return;302===e.statusCode&&e.redirectUrl&&(s.altUrl=e.redirectUrl),this._reportNewMedia(e.tabId,s)}},_reportNewMedia:function(e,t){this._extractVideoTitle(e,t).done(function(i){t.title=i,db.addStreamMedia(e,t)})},_extractVideoTitle:function(e,t){var i=new n.Promise;return chrome.tabs.sendMessage(e,{requestType:"extract_file_name",media:t},function(e){i.resolve(e)}),i},_getMediaType:function(e,t){var i;for(var n in o){i=o[n];for(var s=0;i.contentTypes.length>s;++s)if(e.match(i.contentTypes[s]))return n;if(-1!==i.extensions.indexOf(t))return n}return null},_extByContentType:function(e,t){var i=o[t].ctype2extension;for(var n in i)if(-1!==e.indexOf(n))return i[n];return""}};var d=function(e){this._listeners=e,this._init()};d.prototype={constructor:d,_init:function(){var e=this._onResponseStarted.bind(this),t={urls:["*://*/*"],types:["object","other"]};chrome.webRequest.onBeforeRedirect.addListener(e,t,["responseHeaders"]),chrome.webRequest.onResponseStarted.addListener(e,t,["responseHeaders"])},_onResponseStarted:function(e){var t=this._parseHeaders(e.responseHeaders),i=n.parseUrl(e.url);this._listeners.forEach(function(n){n(e,i,t)})},_parseHeaders:function(e){var t={};return e.length?(e.forEach(function(e){t[e.name.toLowerCase()]=e.value.toLowerCase()}),t):{}}};var f=new h;new d([e,t,i,f.processRequest.bind(f)]),window.onRequest=function(e,t,i){switch(e.requestType){case"reset_all_media":db.resetAllMediaCount(t.tab.id);break;case"reset_media":db.resetMediaCount(t.tab.id);break;case"update_media":break;case"media_count":db.addMediaCount(t.tab.id,e.count);break;case"get_from_cache":i(cache.get(e.key));break;case"put_to_cache":cache.put(e.key,e.value,e.ttl);break;case"delete_from_cache":cache["delete"](e.key);break;case"make_http_request":n.send(e.method,e.url,e.params).success(function(e){i({success:!0,data:e})}).fail(function(e){i({success:!1,data:e})})}return!0},window.db=new l,window.options=new r,window.cache=new u,window.checkDownloadStarted=function(e,t){function i(n){n.tabId===e&&n.url===t&&(chrome.webRequest.onHeadersReceived.removeListener(i),s.resolve())}var s=new n.Promise;return chrome.webRequest.onHeadersReceived.addListener(i,{urls:["*://*/*"],types:["object","other"]},["responseHeaders"]),s},options.load().done(function(){options.get("preferred_quality_level")||options.set("preferred_quality_level",quality.DEFAULT_QUALITY_LEVEL),chrome.extension.onRequest.addListener(onRequest),chrome.tabs.onUpdated.addListener(function(e,t,i){i.url.match(/^chrome:/)&&db.resetAllMediaCount(e),"complete"===t.status&&db.showPageActionState(e)})})})();