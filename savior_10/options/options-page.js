(function(){var t;(function(e){"undefined"!=typeof module&&module.exports?module.exports=e:"function"==typeof define?define(e):t=e})(function(){function t(t,e){return RegExp.prototype.test.call(t,e)}function e(e){return!t(d,e)}function i(t){return t.replace(/[\-\[\]{}()*+?.,\\\^$|#\s]/g,"\\$&")}function n(t){return(t+"").replace(/[&<>"'\/]/g,function(t){return T[t]})}function r(t){this.string=t,this.tail=t,this.pos=0}function o(t,e){this.view=t,this.parent=e,this.clearCache()}function s(){this.clearCache()}function a(t){for(var e,i=t[3],n=i;(e=t[4])&&e.length;)t=e[e.length-1],n=t[3];return[i,n]}function u(t){function e(t,e,i){if(!n[t]){var r=u(e);n[t]=function(t,e){return r(t,e,i)}}return n[t]}function i(i,n,r){for(var o,s,u="",c=0,l=t.length;l>c;++c)switch(o=t[c],o[0]){case"#":s=r.slice.apply(r,a(o)),u+=i._section(o[1],n,s,e(c,o[4],r));break;case"^":u+=i._inverted(o[1],n,e(c,o[4],r));break;case">":u+=i._partial(o[1],n);break;case"&":u+=i._name(o[1],n);break;case"name":u+=i._escaped(o[1],n);break;case"text":u+=o[1]}return u}var n={};return i}function c(t){for(var e,i,n=[],r=n,o=[],s=0;t.length>s;++s)switch(e=t[s],e[0]){case"#":case"^":e[4]=[],o.push(e),r.push(e),r=e[4];break;case"/":if(0===o.length)throw Error("Unopened section: "+e[1]);if(i=o.pop(),i[1]!==e[1])throw Error("Unclosed section: "+i[1]);r=o.length>0?o[o.length-1][4]:n;break;default:r.push(e)}if(i=o.pop())throw Error("Unclosed section: "+i[1]);return n}function l(t){for(var e,i,n=0;t.length>n;++n)e=t[n],i&&"text"===i[0]&&"text"===e[0]?(i[1]+=e[1],i[3]=e[3],t.splice(n--,1)):i=e}function h(t){if(2!==t.length)throw Error("Invalid tags: "+t.join(" "));return[RegExp(i(t[0])+"\\s*"),RegExp("\\s*"+i(t[1]))]}var f={};f.name="mustache.js",f.version="0.7.0",f.tags=["{{","}}"],f.Scanner=r,f.Context=o,f.Writer=s;var p=/\s*/,_=/\s+/,d=/\S/,y=/\s*=/,g=/\s*\}/,m=/#|\^|\/|>|\{|&|=|!/,v=Array.isArray||function(t){return"[object Array]"===Object.prototype.toString.call(t)},T={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;","/":"&#x2F;"};f.escape=n,r.prototype.eos=function(){return""===this.tail},r.prototype.scan=function(t){var e=this.tail.match(t);return e&&0===e.index?(this.tail=this.tail.substring(e[0].length),this.pos+=e[0].length,e[0]):""},r.prototype.scanUntil=function(t){var e,i=this.tail.search(t);switch(i){case-1:e=this.tail,this.pos+=this.tail.length,this.tail="";break;case 0:e="";break;default:e=this.tail.substring(0,i),this.tail=this.tail.substring(i),this.pos+=i}return e},o.make=function(t){return t instanceof o?t:new o(t)},o.prototype.clearCache=function(){this._cache={}},o.prototype.push=function(t){return new o(t,this)},o.prototype.lookup=function(t){var e=this._cache[t];if(!e){if("."===t)e=this.view;else for(var i=this;i;){if(t.indexOf(".")>0){var n=t.split("."),r=0;for(e=i.view;e&&n.length>r;)e=e[n[r++]]}else e=i.view[t];if(null!=e)break;i=i.parent}this._cache[t]=e}return"function"==typeof e&&(e=e.call(this.view)),e},s.prototype.clearCache=function(){this._cache={},this._partialCache={}},s.prototype.compile=function(t,e){return this._compile(this._cache,t,t,e)},s.prototype.compilePartial=function(t,e,i){return this._compile(this._partialCache,t,e,i)},s.prototype.render=function(t,e,i){return this.compile(t)(e,i)},s.prototype._compile=function(t,e,i,n){if(!t[e]){var r=f.parse(i,n),s=u(r),a=this;t[e]=function(t,e){if(e)if("function"==typeof e)a._loadPartial=e;else for(var n in e)a.compilePartial(n,e[n]);return s(a,o.make(t),i)}}return t[e]},s.prototype._section=function(t,e,i,n){var r=e.lookup(t);switch(typeof r){case"object":if(v(r)){for(var o="",s=0,a=r.length;a>s;++s)o+=n(this,e.push(r[s]));return o}return r?n(this,e.push(r)):"";case"function":var u=this,c=function(t){return u.render(t,e)};return r.call(e.view,i,c)||"";default:if(r)return n(this,e)}return""},s.prototype._inverted=function(t,e,i){var n=e.lookup(t);return!n||v(n)&&0===n.length?i(this,e):""},s.prototype._partial=function(t,e){t in this._partialCache||!this._loadPartial||this.compilePartial(t,this._loadPartial(t));var i=this._partialCache[t];return i?i(e):""},s.prototype._name=function(t,e){var i=e.lookup(t);return"function"==typeof i&&(i=i.call(e.view)),null==i?"":i+""},s.prototype._escaped=function(t,e){return f.escape(this._name(t,e))},f.parse=function(t,n){function o(){if(b&&!Q)for(;L.length;)E.splice(L.pop(),1);else L=[];b=!1,Q=!1}n=n||f.tags;for(var s,a,u,d,v=h(n),T=new r(t),E=[],L=[],b=!1,Q=!1;!T.eos();){if(s=T.pos,u=T.scanUntil(v[0]))for(var P=0,I=u.length;I>P;++P)d=u.charAt(P),e(d)?L.push(E.length):Q=!0,E.push(["text",d,s,s+1]),s+=1,"\n"===d&&o();if(s=T.pos,!T.scan(v[0]))break;if(b=!0,a=T.scan(m)||"name",T.scan(p),"="===a)u=T.scanUntil(y),T.scan(y),T.scanUntil(v[1]);else if("{"===a){var k=RegExp("\\s*"+i("}"+n[1]));u=T.scanUntil(k),T.scan(g),T.scanUntil(v[1]),a="&"}else u=T.scanUntil(v[1]);if(!T.scan(v[1]))throw Error("Unclosed tag at "+T.pos);E.push([a,u,s,T.pos]),("name"===a||"{"===a||"&"===a)&&(Q=!0),"="===a&&(n=u.split(_),v=h(n))}return l(E),c(E)};var E=new s;return f.clearCache=function(){return E.clearCache()},f.compile=function(t,e){return E.compile(t,e)},f.compilePartial=function(t,e,i){return E.compilePartial(t,e,i)},f.render=function(t,e,i){return E.render(t,e,i)},f.to_html=function(t,e,i,n){var r=f.render(t,e,i);return"function"!=typeof n?r:(n(r),void 0)},f}());var e={EXTENSION_RE:/\.([^/.]*)$/i,FILENAME_RE:/([^/]+)$/i,SIZES:["","K","M","G","T","P"],xmlParser:new DOMParser,urlParser:document.createElement("a"),fileDownloader:document.createElement("a"),strip:function(t){return t.replace(/(^\s+)|(\s+$)/m,"")},query:function(t){return document.querySelector(t)},queryAll:function(t){return e.toArray(document.querySelectorAll(t))},toArray:function(t){return Array.prototype.slice.call(t)},unique:function(t){var e=[];return Array.isArray(t)?(t.forEach(function(t){-1===e.indexOf(t)&&e.push(t)}),e):t},extend:function(t,e){var i=function(){};i.prototype=t.prototype,e.prototype=new i,e.prototype.constructor=e,e._super=t.prototype},parseUrl:function(t){var i=e.urlParser;i.setAttribute("href",t);var n=(i.pathname.match(e.FILENAME_RE)||[])[1]||"",r=(n.match(e.EXTENSION_RE)||[])[1]||"";return n=n.replace(e.EXTENSION_RE,""),{url:t,protocol:i.protocol,host:i.host,port:i.port,pathname:i.pathname,filename:n,ext:r,search:i.search}},isMatches:function(t,e){e=Array.isArray(e)?e:[e];for(var i,n=0,r=e.length;r>n;++n)if(i=e[n],"string"==typeof i&&-1!==t.indexOf(i)||i instanceof RegExp&&t.match(i))return!0;return!1},_sendBackgroundRequest:function(t,i,n){var r=new e.Promise;return chrome.extension.sendRequest({requestType:"make_http_request",method:t,url:i,params:n},function(t){r[t.success?"resolve":"reject"](t.data)}),r},send:function(t,i,n){var r=new e.Promise,o=null;if(e.IS_CONTENT_SCRIPT)return e._sendBackgroundRequest(t,i,n);try{var s=new XMLHttpRequest;s.open(t,i,!0),s.setRequestHeader("Cache-Control","no-cache"),"object"==typeof n&&(o=Object.keys(n).map(function(t){return t+"="+n[t]}).join("&")),"POST"===t&&s.setRequestHeader("Content-type","application/x-www-form-urlencoded"),s.onload=function(){r.resolve(this.responseText)},s.onerror=function(){r.reject()},s.send(o)}catch(a){r.reject()}return r},get:function(t){return e.send("GET",t)},post:function(t,i){return e.send("POST",t,i)},_getSize:function(t){var i=new XMLHttpRequest,n=new e.Promise;return i.open("GET",t),i.setRequestHeader("Cache-Control","no-cache"),i.url=t,i.onreadystatechange=function(){var t=null;if(this.readyState>1){try{t=this.getResponseHeader("Content-Length")}catch(e){}(null!==t||200===this.status)&&(n[null===t?"reject":"resolve"](t),this.abort())}},i.send(null),n},getSize:function(t){var i=new e.Promise,n=e.IS_CONTENT_SCRIPT?n:chrome.extension.getBackgroundPage().cache;return e.Promise(n.get(t)).success(function(r){r?(i.resolve(r),n.put(t,r)):i.bind(e._getSize(t)).success(n.put.bind(n,t))}).fail(function(){i.bind(e._getSize(t)).success(n.put.bind(n,t))}),i},downloadFile:function(t,i){var n=e.fileDownloader;n.setAttribute("href",t),n.setAttribute("download",i);var r=document.createEvent("MouseEvent");r.initMouseEvent("click",!0,!0,window,1,0,0,0,0,!1,!1,!1,!1,0,null),n.dispatchEvent(r)},beautifyFileSize:function(t){if(null===t||t===void 0)return"???";for(var i=0;e.SIZES.length>i&&t>=1024;++i,t/=1024);return Math.round(10*t)/10+e.SIZES[i]+"b"},isTrue:function(t){return!!t},noop:function(){},defined:function(t){return t!==void 0},notNull:function(t){return null!==t}};try{chrome.extension.getBackgroundPage(),e.IS_CONTENT_SCRIPT=!1}catch(i){e.IS_CONTENT_SCRIPT=!0}e.Promise=function(t){if(0===arguments.length)return this._init(),this;if(t instanceof e.Promise)return t;var i=new e.Promise;return i.resolve(t),i},e.Promise.RUNNING=0,e.Promise.RESOLVED=1,e.Promise.FAILED=2,e.Promise.prototype={constructor:e.Promise,_init:function(){this._results=[],this._subscribers=[],this.state=e.Promise.RUNNING},_notify:function(){var t=this;this._subscribers.forEach(function(e){e.apply(t,t._results)}),this._subscribers=[]},resolve:function(){return this.state=e.Promise.RESOLVED,this._results=arguments,this._notify(),this},reject:function(){return this.state=e.Promise.FAILED,this._results=arguments,this._notify(),this},subscribe:function(t){this.state!==e.Promise.RUNNING?t.apply(this,this._results):this._subscribers.push(t)},done:function(t){return this.subscribe(t),this},success:function(t){var i=this;return this.subscribe(function(){i.state===e.Promise.RESOLVED&&t.apply(i,i._results)}),this},fail:function(t){var i=this;return this.subscribe(function(){i.state===e.Promise.FAILED&&t.apply(i,i._results)}),this},bind:function(t){return t=new e.Promise(t),t.success(this.resolve.bind(this)).fail(this.reject.bind(this)),this}},e.Promise.when=function(){var t=[];return t=Array.isArray(arguments[0])?arguments[0]:e.toArray(arguments),new e.Promise.When(t)},e.Promise.When=function(t){this._doneCallbacks=[],this._successCallbacks=[],this._failCallbacks=[],this._state=e.Promise.RUNNING,this._thingsToDo=t.length,this._results=Array(this._thingsToDo),this._init(t)},e.Promise.When.prototype={constructor:e.Promise.When,_init:function(t){var i=this;t.forEach(function(t,n){t=new e.Promise(t),t.subscribe(function(){t.state===e.Promise.FAILED&&(i._state=e.Promise.FAILED),i._results[n]=e.toArray(arguments),i._thingsToDo--,i._checkIsDone()})}),this._checkIsDone()},_checkIsDone:function(){if(0!==this._thingsToDo)return!1;var t=[];this._results.forEach(function(e){t=t.concat(e)}),this._state===e.Promise.FAILED?this._runCallbacks(this._failCallbacks,t):this._runCallbacks(this._successCallbacks,t),this._runCallbacks(this._doneCallbacks,t),this._doneCallbacks=[],this._successCallbacks=[],this._failCallbacks=[]},_runCallbacks:function(t,e){t.forEach(function(t){t.apply(this,e)})},done:function(t){return this._doneCallbacks.push(t),this._checkIsDone(),this},success:function(t){return this._successCallbacks.push(t),this._checkIsDone(),this},fail:function(t){return this._failCallbacks.push(t),this._checkIsDone(),this}},e.Promise.chain=function(){function t(i){if(!i.length)return n.resolve.apply(n,r);var o,s=i.shift();"function"==typeof s?(o=e.Promise(s()),o.done(function(e){r.push(e),t(i)})):(r.push(s),t(i))}var i,n=new e.Promise,r=[];return i=Array.isArray(arguments[0])?arguments[0]:e.toArray(arguments),t(i),n};var n=function(){this._storage=chrome.storage.local,this._options={}};n.prototype={load:function(){var t=new e.Promise,i=this;return this._storage.get(null,function(e){i._options=e,t.resolve(e)}),t},set:function(t,e){var i={};("string"==typeof t||"number"==typeof t&&e!==void 0)&&(i[t]=e,this._options[t]=e,this._storage.set(i))},get:function(t){return this._options[t]}};var r=function(){};r.QL_HIGH="High",r.QL_MEDIUM="Medium",r.QL_LOW="Low",r.prototype={constructor:r,WEIGHTS:{format:1,quality:1},DEFAULT_QUALITY_LEVEL:r.QL_MEDIUM,QUALITY_LEVELS:[r.QL_HIGH,r.QL_MEDIUM,r.QL_LOW],DEFAULT_QUALITY_TYPE:"Standard",QUALITY_TYPES:{"Full HD":{itag:[37,46],vimeoQuality:"",zingTag:"f1080",dailymotionQuality:"hd1080URL",clipvnQuality:"5",quality:r.QL_HIGH,videoTitle:"Full HD",audioTitle:"High"},HD:{itag:[22,45],zingTag:["f720","hq"],vimeoQuality:"hd",dailymotionQuality:"hd720URL",facebookQuality:"hd_src",clipvnQuality:"4",quality:r.QL_HIGH,videoTitle:"HD",audioTitle:"High"},Standard:{itag:[44,35],zingTag:"f480",dailymotionQuality:"hqURL",vimeoQuality:"sd",facebookQuality:"sd_src",clipvnQuality:"3",quality:r.QL_MEDIUM,videoTitle:"Standard",audioTitle:"Normal"},Medium:{itag:[18,43,34],vimeoQuality:"",dailymotionQuality:"sdURL",zingTag:"source",clipvnQuality:"2",quality:r.QL_MEDIUM,videoTitle:"Medium",audioTitle:"Normal"},Small:{itag:[36,5],dailymotionQuality:"ldURL",vimeoQuality:"mobile",clipvnQuality:"1",quality:r.QL_LOW,videoTitle:"Small",audioTitle:"Low"},Mobile:{itag:[17,6],vimeoQuality:"",clipvnQuality:"0",quality:r.QL_LOW,videoTitle:"Mobile",audioTitle:"Low"}},getFacebookQuality:function(t){return this._getVideoQuality("facebookQuality",t).videoTitle},getDailymotionQuality:function(t){return this._getVideoQuality("dailymotionQuality",t).videoTitle},getZingVideoQuality:function(t){return this._getVideoQuality("zingTag",t).videoTitle},getZingAudioQuality:function(t){return this._getVideoQuality("zingTag",t).audioTitle},getYoutubeQuality:function(t){return this._getVideoQuality("itag",+t).videoTitle},getVimeoQuality:function(t){return this._getVideoQuality("vimeoQuality",t).videoTitle},getClipvnQuality:function(t){return this._getVideoQuality("clipvnQuality",t).videoTitle},_getVideoQuality:function(t,e){for(var i in this.QUALITY_TYPES){var n=this.QUALITY_TYPES[i][t];if(Array.isArray(n)||(n=[n]),-1!==n.indexOf(e))return this.QUALITY_TYPES[i]}return this.QUALITY_TYPES[this.DEFAULT_QUALITY_TYPE]},_getTypeByQualityType:function(t){for(var e in this.QUALITY_TYPES)if(t===e||t===this.QUALITY_TYPES[e].videoTitle||t===this.QUALITY_TYPES[e].audioTitle)return this.QUALITY_TYPES[e];return this.QUALITY_TYPES[this.DEFAULT_QUALITY_TYPE]},getQualityLevelByType:function(t){return Object.keys(this.QUALITY_TYPES).indexOf(this._getTypeByQualityType(t).videoTitle)},_calculateWeight:function(t,e){var i=MEDIA_TYPES[e.get("type")].extensions,n=i.indexOf(e.get("ext")),r=this._getTypeByQualityType(e.get("quality")),o=this.QUALITY_LEVELS.indexOf(r.quality),s=this.WEIGHTS.format*(i.length-n-1)/i.length+this.WEIGHTS.quality*(this.QUALITY_LEVELS.length-Math.abs(t-o)-1)/this.QUALITY_LEVELS.length;return s},chooseBestDownload:function(t,e){e=e||this.DEFAULT_QUALITY_LEVEL;var i=this.QUALITY_LEVELS.indexOf(e),n=t.map(this._calculateWeight.bind(this,i)),r=0;return n.forEach(function(t,e){t>n[r]&&(r=e)}),t[r]}},window.quality=new r;var o,s=chrome.i18n.getMessage;o=chrome.storage?chrome.extension.getBackgroundPage().options:{preferred_quality_level:"High",one_click:!0,get:function(t){return this[t]},load:function(){return{done:function(t){t()}}},set:function(){console.log("set",arguments[0],"to",arguments[1])}},o.load().done(function(){var i=e.query("#options"),n=o.get("preferred_quality_level"),r={isOneClickEnabled:o.get("one_click"),qLevels:quality.QUALITY_LEVELS.map(function(t){return{i18n_ql_title:s("ql_"+t.toLowerCase()),qLevelName:t,isChecked:t===n}}),i18n_options_title:s("options_title"),i18n_one_click:s("options_one_click"),i18n_preferred_quality:s("options_preferred_quality")},a=e.query("#options-template").textContent;i.innerHTML=t.render(a,r);var u=e.query("#media-quality");e.query("#options").addEventListener("click",function(t){var e=t.target;switch("close-button"===e.id&&window.close(),e.getAttribute("type")){case"checkbox":o.set("one_click",!!e.checked),u.classList[e.checked?"remove":"add"]("disabled");break;case"radio":o.set("preferred_quality_level",e.value)}},!1),window.addEventListener("focus",function(){location.reload()},!1)})})();