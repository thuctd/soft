(function(){var t;(function(e){"undefined"!=typeof module&&module.exports?module.exports=e:"function"==typeof define?define(e):t=e})(function(){function t(t,e){return RegExp.prototype.test.call(t,e)}function e(e){return!t(_,e)}function i(t){return t.replace(/[\-\[\]{}()*+?.,\\\^$|#\s]/g,"\\$&")}function n(t){return(t+"").replace(/[&<>"'\/]/g,function(t){return w[t]})}function o(t){this.string=t,this.tail=t,this.pos=0}function r(t,e){this.view=t,this.parent=e,this.clearCache()}function s(){this.clearCache()}function a(t){for(var e,i=t[3],n=i;(e=t[4])&&e.length;)t=e[e.length-1],n=t[3];return[i,n]}function l(t){function e(t,e,i){if(!n[t]){var o=l(e);n[t]=function(t,e){return o(t,e,i)}}return n[t]}function i(i,n,o){for(var r,s,l="",u=0,c=t.length;c>u;++u)switch(r=t[u],r[0]){case"#":s=o.slice.apply(o,a(r)),l+=i._section(r[1],n,s,e(u,r[4],o));break;case"^":l+=i._inverted(r[1],n,e(u,r[4],o));break;case">":l+=i._partial(r[1],n);break;case"&":l+=i._name(r[1],n);break;case"name":l+=i._escaped(r[1],n);break;case"text":l+=r[1]}return l}var n={};return i}function u(t){for(var e,i,n=[],o=n,r=[],s=0;t.length>s;++s)switch(e=t[s],e[0]){case"#":case"^":e[4]=[],r.push(e),o.push(e),o=e[4];break;case"/":if(0===r.length)throw Error("Unopened section: "+e[1]);if(i=r.pop(),i[1]!==e[1])throw Error("Unclosed section: "+i[1]);o=r.length>0?r[r.length-1][4]:n;break;default:o.push(e)}if(i=r.pop())throw Error("Unclosed section: "+i[1]);return n}function c(t){for(var e,i,n=0;t.length>n;++n)e=t[n],i&&"text"===i[0]&&"text"===e[0]?(i[1]+=e[1],i[3]=e[3],t.splice(n--,1)):i=e}function h(t){if(2!==t.length)throw Error("Invalid tags: "+t.join(" "));return[RegExp(i(t[0])+"\\s*"),RegExp("\\s*"+i(t[1]))]}var d={};d.name="mustache.js",d.version="0.7.0",d.tags=["{{","}}"],d.Scanner=o,d.Context=r,d.Writer=s;var p=/\s*/,f=/\s+/,_=/\S/,y=/\s*=/,m=/\s*\}/,g=/#|\^|\/|>|\{|&|=|!/,v=Array.isArray||function(t){return"[object Array]"===Object.prototype.toString.call(t)},w={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;","/":"&#x2F;"};d.escape=n,o.prototype.eos=function(){return""===this.tail},o.prototype.scan=function(t){var e=this.tail.match(t);return e&&0===e.index?(this.tail=this.tail.substring(e[0].length),this.pos+=e[0].length,e[0]):""},o.prototype.scanUntil=function(t){var e,i=this.tail.search(t);switch(i){case-1:e=this.tail,this.pos+=this.tail.length,this.tail="";break;case 0:e="";break;default:e=this.tail.substring(0,i),this.tail=this.tail.substring(i),this.pos+=i}return e},r.make=function(t){return t instanceof r?t:new r(t)},r.prototype.clearCache=function(){this._cache={}},r.prototype.push=function(t){return new r(t,this)},r.prototype.lookup=function(t){var e=this._cache[t];if(!e){if("."===t)e=this.view;else for(var i=this;i;){if(t.indexOf(".")>0){var n=t.split("."),o=0;for(e=i.view;e&&n.length>o;)e=e[n[o++]]}else e=i.view[t];if(null!=e)break;i=i.parent}this._cache[t]=e}return"function"==typeof e&&(e=e.call(this.view)),e},s.prototype.clearCache=function(){this._cache={},this._partialCache={}},s.prototype.compile=function(t,e){return this._compile(this._cache,t,t,e)},s.prototype.compilePartial=function(t,e,i){return this._compile(this._partialCache,t,e,i)},s.prototype.render=function(t,e,i){return this.compile(t)(e,i)},s.prototype._compile=function(t,e,i,n){if(!t[e]){var o=d.parse(i,n),s=l(o),a=this;t[e]=function(t,e){if(e)if("function"==typeof e)a._loadPartial=e;else for(var n in e)a.compilePartial(n,e[n]);return s(a,r.make(t),i)}}return t[e]},s.prototype._section=function(t,e,i,n){var o=e.lookup(t);switch(typeof o){case"object":if(v(o)){for(var r="",s=0,a=o.length;a>s;++s)r+=n(this,e.push(o[s]));return r}return o?n(this,e.push(o)):"";case"function":var l=this,u=function(t){return l.render(t,e)};return o.call(e.view,i,u)||"";default:if(o)return n(this,e)}return""},s.prototype._inverted=function(t,e,i){var n=e.lookup(t);return!n||v(n)&&0===n.length?i(this,e):""},s.prototype._partial=function(t,e){t in this._partialCache||!this._loadPartial||this.compilePartial(t,this._loadPartial(t));var i=this._partialCache[t];return i?i(e):""},s.prototype._name=function(t,e){var i=e.lookup(t);return"function"==typeof i&&(i=i.call(e.view)),null==i?"":i+""},s.prototype._escaped=function(t,e){return d.escape(this._name(t,e))},d.parse=function(t,n){function r(){if(E&&!L)for(;b.length;)T.splice(b.pop(),1);else b=[];E=!1,L=!1}n=n||d.tags;for(var s,a,l,_,v=h(n),w=new o(t),T=[],b=[],E=!1,L=!1;!w.eos();){if(s=w.pos,l=w.scanUntil(v[0]))for(var A=0,k=l.length;k>A;++A)_=l.charAt(A),e(_)?b.push(T.length):L=!0,T.push(["text",_,s,s+1]),s+=1,"\n"===_&&r();if(s=w.pos,!w.scan(v[0]))break;if(E=!0,a=w.scan(g)||"name",w.scan(p),"="===a)l=w.scanUntil(y),w.scan(y),w.scanUntil(v[1]);else if("{"===a){var Q=RegExp("\\s*"+i("}"+n[1]));l=w.scanUntil(Q),w.scan(m),w.scanUntil(v[1]),a="&"}else l=w.scanUntil(v[1]);if(!w.scan(v[1]))throw Error("Unclosed tag at "+w.pos);T.push([a,l,s,w.pos]),("name"===a||"{"===a||"&"===a)&&(L=!0),"="===a&&(n=l.split(f),v=h(n))}return c(T),u(T)};var T=new s;return d.clearCache=function(){return T.clearCache()},d.compile=function(t,e){return T.compile(t,e)},d.compilePartial=function(t,e,i){return T.compilePartial(t,e,i)},d.render=function(t,e,i){return T.render(t,e,i)},d.to_html=function(t,e,i,n){var o=d.render(t,e,i);return"function"!=typeof n?o:(n(o),void 0)},d}());var e={EXTENSION_RE:/\.([^/.]*)$/i,FILENAME_RE:/([^/]+)$/i,SIZES:["","K","M","G","T","P"],xmlParser:new DOMParser,urlParser:document.createElement("a"),fileDownloader:document.createElement("a"),strip:function(t){return t.replace(/(^\s+)|(\s+$)/m,"")},query:function(t){return document.querySelector(t)},queryAll:function(t){return e.toArray(document.querySelectorAll(t))},toArray:function(t){return Array.prototype.slice.call(t)},unique:function(t){var e=[];return Array.isArray(t)?(t.forEach(function(t){-1===e.indexOf(t)&&e.push(t)}),e):t},extend:function(t,e){var i=function(){};i.prototype=t.prototype,e.prototype=new i,e.prototype.constructor=e,e._super=t.prototype},parseUrl:function(t){var i=e.urlParser;i.setAttribute("href",t);var n=(i.pathname.match(e.FILENAME_RE)||[])[1]||"",o=(n.match(e.EXTENSION_RE)||[])[1]||"";return n=n.replace(e.EXTENSION_RE,""),{url:t,protocol:i.protocol,host:i.host,port:i.port,pathname:i.pathname,filename:n,ext:o,search:i.search}},isMatches:function(t,e){e=Array.isArray(e)?e:[e];for(var i,n=0,o=e.length;o>n;++n)if(i=e[n],"string"==typeof i&&-1!==t.indexOf(i)||i instanceof RegExp&&t.match(i))return!0;return!1},_sendBackgroundRequest:function(t,i,n){var o=new e.Promise;return chrome.extension.sendRequest({requestType:"make_http_request",method:t,url:i,params:n},function(t){o[t.success?"resolve":"reject"](t.data)}),o},send:function(t,i,n){var o=new e.Promise,r=null;if(e.IS_CONTENT_SCRIPT)return e._sendBackgroundRequest(t,i,n);try{var s=new XMLHttpRequest;s.open(t,i,!0),s.setRequestHeader("Cache-Control","no-cache"),"object"==typeof n&&(r=Object.keys(n).map(function(t){return t+"="+n[t]}).join("&")),"POST"===t&&s.setRequestHeader("Content-type","application/x-www-form-urlencoded"),s.onload=function(){o.resolve(this.responseText)},s.onerror=function(){o.reject()},s.send(r)}catch(a){o.reject()}return o},get:function(t){return e.send("GET",t)},post:function(t,i){return e.send("POST",t,i)},_getSize:function(t){var i=new XMLHttpRequest,n=new e.Promise;return i.open("GET",t),i.setRequestHeader("Cache-Control","no-cache"),i.url=t,i.onreadystatechange=function(){var t=null;if(this.readyState>1){try{t=this.getResponseHeader("Content-Length")}catch(e){}(null!==t||200===this.status)&&(n[null===t?"reject":"resolve"](t),this.abort())}},i.send(null),n},getSize:function(t){var i=new e.Promise,n=e.IS_CONTENT_SCRIPT?n:chrome.extension.getBackgroundPage().cache;return e.Promise(n.get(t)).success(function(o){o?(i.resolve(o),n.put(t,o)):i.bind(e._getSize(t)).success(n.put.bind(n,t))}).fail(function(){i.bind(e._getSize(t)).success(n.put.bind(n,t))}),i},downloadFile:function(t,i){var n=e.fileDownloader;n.setAttribute("href",t),n.setAttribute("download",i);var o=document.createEvent("MouseEvent");o.initMouseEvent("click",!0,!0,window,1,0,0,0,0,!1,!1,!1,!1,0,null),n.dispatchEvent(o)},beautifyFileSize:function(t){if(null===t||t===void 0)return"???";for(var i=0;e.SIZES.length>i&&t>=1024;++i,t/=1024);return Math.round(10*t)/10+e.SIZES[i]+"b"},isTrue:function(t){return!!t},noop:function(){},defined:function(t){return t!==void 0},notNull:function(t){return null!==t}};try{chrome.extension.getBackgroundPage(),e.IS_CONTENT_SCRIPT=!1}catch(i){e.IS_CONTENT_SCRIPT=!0}e.Promise=function(t){if(0===arguments.length)return this._init(),this;if(t instanceof e.Promise)return t;var i=new e.Promise;return i.resolve(t),i},e.Promise.RUNNING=0,e.Promise.RESOLVED=1,e.Promise.FAILED=2,e.Promise.prototype={constructor:e.Promise,_init:function(){this._results=[],this._subscribers=[],this.state=e.Promise.RUNNING},_notify:function(){var t=this;this._subscribers.forEach(function(e){e.apply(t,t._results)}),this._subscribers=[]},resolve:function(){return this.state=e.Promise.RESOLVED,this._results=arguments,this._notify(),this},reject:function(){return this.state=e.Promise.FAILED,this._results=arguments,this._notify(),this},subscribe:function(t){this.state!==e.Promise.RUNNING?t.apply(this,this._results):this._subscribers.push(t)},done:function(t){return this.subscribe(t),this},success:function(t){var i=this;return this.subscribe(function(){i.state===e.Promise.RESOLVED&&t.apply(i,i._results)}),this},fail:function(t){var i=this;return this.subscribe(function(){i.state===e.Promise.FAILED&&t.apply(i,i._results)}),this},bind:function(t){return t=new e.Promise(t),t.success(this.resolve.bind(this)).fail(this.reject.bind(this)),this}},e.Promise.when=function(){var t=[];return t=Array.isArray(arguments[0])?arguments[0]:e.toArray(arguments),new e.Promise.When(t)},e.Promise.When=function(t){this._doneCallbacks=[],this._successCallbacks=[],this._failCallbacks=[],this._state=e.Promise.RUNNING,this._thingsToDo=t.length,this._results=Array(this._thingsToDo),this._init(t)},e.Promise.When.prototype={constructor:e.Promise.When,_init:function(t){var i=this;t.forEach(function(t,n){t=new e.Promise(t),t.subscribe(function(){t.state===e.Promise.FAILED&&(i._state=e.Promise.FAILED),i._results[n]=e.toArray(arguments),i._thingsToDo--,i._checkIsDone()})}),this._checkIsDone()},_checkIsDone:function(){if(0!==this._thingsToDo)return!1;var t=[];this._results.forEach(function(e){t=t.concat(e)}),this._state===e.Promise.FAILED?this._runCallbacks(this._failCallbacks,t):this._runCallbacks(this._successCallbacks,t),this._runCallbacks(this._doneCallbacks,t),this._doneCallbacks=[],this._successCallbacks=[],this._failCallbacks=[]},_runCallbacks:function(t,e){t.forEach(function(t){t.apply(this,e)})},done:function(t){return this._doneCallbacks.push(t),this._checkIsDone(),this},success:function(t){return this._successCallbacks.push(t),this._checkIsDone(),this},fail:function(t){return this._failCallbacks.push(t),this._checkIsDone(),this}},e.Promise.chain=function(){function t(i){if(!i.length)return n.resolve.apply(n,o);var r,s=i.shift();"function"==typeof s?(r=e.Promise(s()),r.done(function(e){o.push(e),t(i)})):(o.push(s),t(i))}var i,n=new e.Promise,o=[];return i=Array.isArray(arguments[0])?arguments[0]:e.toArray(arguments),t(i),n};var n={audio:{title:"Audio",contentTypes:[/audio/i],extensions:["mp3","flac","m4a","wma","ogg","wav","aif","mid"],ctype2extension:{midi:"mid",m4a:"m4a",mpeg:"mp3",mpeg3:"mp3",wav:"wav",aiff:"aif"}},video:{title:"Video",contentTypes:[/video/i],extensions:["mp4","mpeg4","mpg","mpeg","m4v","avi","divx","mov","wmv","movie","asf","webm","flv","3gp"],ctype2extension:{mpeg:"mp4",mp4:"mp4",m4v:"mp4","3gpp":"3gp",flv:"flv",quicktime:"mov",msvideo:"avi","ms-wmv":"wmv","ms-asf":"asf"}}},o=function(){};o.QL_HIGH="High",o.QL_MEDIUM="Medium",o.QL_LOW="Low",o.prototype={constructor:o,WEIGHTS:{format:1,quality:1},DEFAULT_QUALITY_LEVEL:o.QL_MEDIUM,QUALITY_LEVELS:[o.QL_HIGH,o.QL_MEDIUM,o.QL_LOW],DEFAULT_QUALITY_TYPE:"Standard",QUALITY_TYPES:{"Full HD":{itag:[37,46],vimeoQuality:"",zingTag:"f1080",dailymotionQuality:"hd1080URL",clipvnQuality:"5",quality:o.QL_HIGH,videoTitle:"Full HD",audioTitle:"High"},HD:{itag:[22,45],zingTag:["f720","hq"],vimeoQuality:"hd",dailymotionQuality:"hd720URL",facebookQuality:"hd_src",clipvnQuality:"4",quality:o.QL_HIGH,videoTitle:"HD",audioTitle:"High"},Standard:{itag:[44,35],zingTag:"f480",dailymotionQuality:"hqURL",vimeoQuality:"sd",facebookQuality:"sd_src",clipvnQuality:"3",quality:o.QL_MEDIUM,videoTitle:"Standard",audioTitle:"Normal"},Medium:{itag:[18,43,34],vimeoQuality:"",dailymotionQuality:"sdURL",zingTag:"source",clipvnQuality:"2",quality:o.QL_MEDIUM,videoTitle:"Medium",audioTitle:"Normal"},Small:{itag:[36,5],dailymotionQuality:"ldURL",vimeoQuality:"mobile",clipvnQuality:"1",quality:o.QL_LOW,videoTitle:"Small",audioTitle:"Low"},Mobile:{itag:[17,6],vimeoQuality:"",clipvnQuality:"0",quality:o.QL_LOW,videoTitle:"Mobile",audioTitle:"Low"}},getFacebookQuality:function(t){return this._getVideoQuality("facebookQuality",t).videoTitle},getDailymotionQuality:function(t){return this._getVideoQuality("dailymotionQuality",t).videoTitle},getZingVideoQuality:function(t){return this._getVideoQuality("zingTag",t).videoTitle},getZingAudioQuality:function(t){return this._getVideoQuality("zingTag",t).audioTitle},getYoutubeQuality:function(t){return this._getVideoQuality("itag",+t).videoTitle},getVimeoQuality:function(t){return this._getVideoQuality("vimeoQuality",t).videoTitle},getClipvnQuality:function(t){return this._getVideoQuality("clipvnQuality",t).videoTitle},_getVideoQuality:function(t,e){for(var i in this.QUALITY_TYPES){var n=this.QUALITY_TYPES[i][t];if(Array.isArray(n)||(n=[n]),-1!==n.indexOf(e))return this.QUALITY_TYPES[i]}return this.QUALITY_TYPES[this.DEFAULT_QUALITY_TYPE]},_getTypeByQualityType:function(t){for(var e in this.QUALITY_TYPES)if(t===e||t===this.QUALITY_TYPES[e].videoTitle||t===this.QUALITY_TYPES[e].audioTitle)return this.QUALITY_TYPES[e];return this.QUALITY_TYPES[this.DEFAULT_QUALITY_TYPE]},getQualityLevelByType:function(t){return Object.keys(this.QUALITY_TYPES).indexOf(this._getTypeByQualityType(t).videoTitle)},_calculateWeight:function(t,e){var i=n[e.get("type")].extensions,o=i.indexOf(e.get("ext")),r=this._getTypeByQualityType(e.get("quality")),s=this.QUALITY_LEVELS.indexOf(r.quality),a=this.WEIGHTS.format*(i.length-o-1)/i.length+this.WEIGHTS.quality*(this.QUALITY_LEVELS.length-Math.abs(t-s)-1)/this.QUALITY_LEVELS.length;return a},chooseBestDownload:function(t,e){e=e||this.DEFAULT_QUALITY_LEVEL;var i=this.QUALITY_LEVELS.indexOf(e),n=t.map(this._calculateWeight.bind(this,i)),o=0;return n.forEach(function(t,e){t>n[o]&&(o=e)}),t[o]}},window.quality=new o;var r=chrome.i18n.getMessage,s=function(){this._oneClickDownload=!1,chrome.tabs.query({windowId:chrome.windows.WINDOW_ID_CURRENT,active:!0},this._init.bind(this))};s.prototype={constructor:s,SPLIT_SEQUENCE:["type","title","ext","quality"],_init:function(t){var i=this;this._tabId=t[0].id,this._downloads=e.query("#downloads"),this._template=e.query("#list-template").textContent,this._welcome=e.query("#welcome"),document.addEventListener("click",this._onClick.bind(this),!1),document.addEventListener("change",this._onSelectChange.bind(this),!1),this._db=chrome.extension.getBackgroundPage().db,this._options=chrome.extension.getBackgroundPage().options,this._cache=chrome.extension.getBackgroundPage().cache,this._oneClickDownload=!!this._options.get("one_click"),this._drawPopupContent(),this._db.getMediaForTab(this._tabId,window).done(function(t){if(i._downloadsObj=t,i._oneClickDownload&&i._isSingleDownload(t)){var e=quality.chooseBestDownload(t,i._options.get("preferred_quality_level"));i._showOneClickDownloadScreen(e),i._startDownload(e.url(),e.title()+"."+e.ext())}else i._render(t)})},_drawPopupContent:function(){var t=!this._options.get("not_first_run");t&&(this._showWelcomeScreen(),this._options.set("not_first_run",!0)),this._downloads[t?"setAttribute":"removeAttribute"]("hidden",!0),this._welcome[t?"removeAttribute":"setAttribute"]("hidden",!0)},_showWelcomeScreen:function(){var i=e.query("#welcome-template").textContent,n=t.render(i,{i18n_welcome_title:r("popup_welcome_title"),i18n_welcome_text:r("popup_welcome_text"),i18n_welcome_button:r("popup_welcome_button")});this._welcome.innerHTML=n},_showOneClickDownloadScreen:function(i){var n=e.query("#one-click-block"),o=e.query("#one-click-template").textContent,s=t.render(o,{media:i,i18n_starting_download:r("popup_starting_download")});n.innerHTML=s,this._downloads.setAttribute("hidden",!0),n.removeAttribute("hidden")},_isSingleDownload:function(t){for(var e,i,n={},o=0,r=0;t.length>o&&1>=r;++o)if(e=t[o],i=e.title()+e.type(),!n[i]&&(n[i]=!0,++r>1))return!1;return!0},_updateFileSize:function(t){var i=e.query("#size_"+t.id());i&&(i.classList.add("done"),i.textContent=t.size())},_startDownload:function(t,e){chrome.pageAction.allowMultipleDownloads&&chrome.pageAction.allowMultipleDownloads(),chrome.tabs.sendMessage(this._tabId,{requestType:"download_file",url:t,filename:e}),chrome.extension.getBackgroundPage().checkDownloadStarted(this._tabId,t).done(function(){setTimeout(function(){window&&window.close()},500)})},_onClick:function(t){var i=t.target;switch(i.tagName){case"A":if("close-popup"===i.id)return window.close(),!1;if("welcome-button"===i.id)return this._drawPopupContent(),setTimeout(function(){document.body.className+=""},0),!1;break;case"SPAN":var n=i.parentNode;if(!n.classList.contains("download"))return!1;n.classList.contains("j-disabled")||(n.classList.add("j-disabled"),n.classList.add("btn-progress"),this._startDownload(n.href,n.dataset.filename)),t.preventDefault();break;case"INPUT":this._options.set("one_click",!!i.checked),e.query("#quality-level").classList[i.checked?"remove":"add"]("disabled"),e.query("#quality-level-selection")[i.checked?"removeAttribute":"setAttribute"]("disabled",!0)}return!1},_parent:function(t,e){for(;null!==t&&!t.classList.contains(e);)t=t.parentNode;return t},_onSelectChange:function(t){var e=t.target;if("SELECT"===t.target.tagName){if("quality-level-selection"===t.target.id)this._options.set("preferred_quality_level",t.target.value);else{var i=this._parent(e,"j-media-scope");this._applyCurrentValues(i)}return!1}},_checkFileSize:function(t){var e=this._downloadsObj.filter(function(e){return e.id()==t&&!e.get("size")})[0];e&&e.getSize().done(this._updateFileSize.bind(this,e))},_applyCurrentValues:function(t){var i=this,n=t.querySelector(".j-format-selector option:checked"),o=n.dataset.format,r=n.dataset.quality;e.toArray(t.querySelectorAll("a, .j-format-dependent")).forEach(function(t){t.dataset.format!==o||t.dataset.quality!==r&&void 0!==t.dataset.quality?t.setAttribute("hidden","true"):(t.removeAttribute("hidden"),t.dataset.id&&i._checkFileSize(+t.dataset.id))})},_splitMediaByFields:function(t,e){var i=this,n=e[0],o={};return n?(t.forEach(function(t){var e=t[n]&&t[n]()||void 0;o[e]=o[e]||[],o[e].push(t)}),Object.keys(o).map(function(t){var s=i._splitMediaByFields(o[t],e.slice(1)),a={media:s};return a[n]="undefined"===t?void 0:t,a.is_only=1===s.length&&(s[0].is_only===void 0||s[0].is_only),a["i18n_"+n]=r("media_fields_"+n+"_"+t),a})):(t[0].i18n_download=r("popup_download"),t[0].i18n_wait=r("popup_download_starting"),[t[0]])},_sortMediaFormatsByPriority:function(t){return t.forEach(function(t){var e=t.type;t.media.forEach(function(t){t.media=t.media.sort(function(t,i){return n[e].extensions.indexOf(t.ext)-n[e].extensions.indexOf(i.ext)})})}),t},_sortMediaByQuality:function(t){return t.ext?(t.media=t.media.sort(function(t,e){return quality.getQualityLevelByType(t.quality)-quality.getQualityLevelByType(e.quality)}),t):(Array.isArray(t)?t=t.map(this._sortMediaByQuality.bind(this)):t.media=this._sortMediaByQuality(t.media),t)},_render:function(i){var n=this,o=this._splitMediaByFields(i,this.SPLIT_SEQUENCE.concat()),s=this._options.get("preferred_quality_level"),a={downloads:this._sortMediaByQuality(this._sortMediaFormatsByPriority(o)),is_single:this._oneClickDownload,quality_levels:quality.QUALITY_LEVELS.map(function(t){return{i18n_ql_title:r("ql_"+t.toLowerCase()),name:t,is_checked:t===s}}),i18n_one_click:r("popup_one_click"),i18n_preferred_quality:r("popup_preferred_quality"),i18n_no_media_found:r("popup_no_media_found")},l=t.render(this._template,a);this._downloads.innerHTML=l,e.queryAll(".j-media-scope").forEach(function(t){n._applyCurrentValues(t)});var u=e.query("#downloads-list");u.scrollHeight>u.offsetHeight&&(this._stickyHeaders(e.queryAll("#downloads-list h1"),u),e.query("#close-popup").classList.add("pulled")),document.body.classList.add("done")},_stickyHeaders:function(t,e){function i(){for(var t=10,i=e.scrollTop,s=-1;o-1>s&&i>=n[s+1].top;)s++;return-1===s?!1:(r!==s&&(-1!==r&&(n[r].node.style.position="static",n[r].placeholder.setAttribute("hidden","")),n[s].node.style.position="fixed",n[s].placeholder.removeAttribute("hidden"),r=s),s!==o-1&&i+n[s].height>n[s+1].top?(n[s].node.style.top=t-(i+n[s].height-n[s+1].top)+"px",n[s].node.classList.contains("pulled")||n[s].node.classList.add("pulled")):(n[s].node.style.top=t+"px",n[s].node.classList.contains("pulled")&&n[s].node.classList.remove("pulled")),!1)}var n=[],o=t.length,r=-1;1>o||(e.style.position="relative",n=t.map(function(t){var e=document.createElement("div");return e.style.height=t.offsetHeight+"px",e.setAttribute("hidden",""),t.parentNode.insertBefore(e,t),{node:t,top:t.offsetTop,height:t.offsetHeight,placeholder:e}}),e.addEventListener("scroll",i,!1))}},window.onload=function(){new s}})();